#     

****: 2026-01-06  
****:  (ddoksori_demo)  
****: RAG         

---

##  

1. [  ](#1---)
2. [   ](#2----)
3. [  ](#3---)
4. [  ](#4---)
5. [ ](#5--)
6. [ ](#6--)

---

## 1.   

### 1.1 RAG  

```
[ ]
    ↓
[1:  ]
     law () 
     criteria () 
    ↓
[ : KCA/KCDRC/ECMC]
    ↓
[2:   ]
     dispute_resolution ( -   O)
     compensation_case ( -   X)
    ↓
[LLM  ]
```

### 1.2   

|  |   |  |   |
|-----|-----------|-----|---------|
| **Tier 1** | law + criteria |      |  |
| **Tier 2** | dispute_resolution |    |   |
| **Tier 3** | compensation_case |    |   |

---

## 2.    

### 2.1   (law/)

** **: 11  
**  **: ~4,000  
****:      

####  
```json
{
  "unit_id": "001706|A1",
  "law_id": "001706",
  "law_name": "",
  "unit_level": "article|paragraph|item|subitem",
  "path": " 1",
  "article_no": "1",
  "index_text": "1()  ...",
  "node_refs": ["001706|A1"],
  "source_type": "statute"
}
```

####  
- **doc_id**: `statute:{law_id}` (: `statute:001706`)
- **doc_type**: `law`
- **title**: `{law_name}`
- **source_org**: `statute`
- **chunk_id**: `statute:{law_id}:{unit_id}` (: `statute:001706:001706|A1`)
- **chunk_type**: `{unit_level}` (article, paragraph, item, subitem)
- **content**: `[] {law_name}\n[] {path}\n\n{index_text}`

---

### 2.2   (criteria/)

** **: 6  
**  **: ~900  
****:    

#### 2.2.1 table1_item_chunks.jsonl ( )

```json
{
  "source": "table1",
  "record_type": "item_chunk",
  "stable_id": "table1:item:...",
  "embed_text": "\n:  / \n: ()",
  "metadata": {
    "item_name": "",
    "category": "()",
    "industry": "",
    "item_group": ""
  }
}
```

** **:
- **doc_id**: `criteria:table1`
- **doc_type**: `criteria_item`
- **title**: ` - `
- **source_org**: `KCA`
- **chunk_id**: `{stable_id}`
- **chunk_type**: `item_classification`
- **content**: `{embed_text}`
- **category_path**: `[{category}, {industry}, {item_group}]`

#### 2.2.2 table2_resolution_row_chunks.jsonl ()

```json
{
  "source": "table2",
  "chunk_type": "resolution_row",
  "chunk_id": "table2_row_p1_part1_4_1_...",
  "category": "I. ()",
  "item_group": "1. - - (7 )",
  "item": "1, 2...",
  "dispute_type": ", , ,  ...",
  "resolution": "o     ",
  "laws": [{"law_name": "", "law_id": "000422", ...}],
  "text": "category: ... | resolution: ..."
}
```

** **:
- **doc_id**: `criteria:table2`
- **doc_type**: `criteria_resolution`
- **title**: ` -  `
- **source_org**: `KCA`
- **chunk_id**: `{chunk_id}` ( )
- **chunk_type**: `resolution_row`
- **content**: `{text}`
- **category_path**: `[{category}, {item_group}, {item}]`
- **metadata**: laws  JSONB 

#### 2.2.3   

|  | doc_type |  |
|-----|----------|-----|
| table3_warranty_chunks.jsonl | `criteria_warranty` |   |
| table4_lifespan_chunks.jsonl | `criteria_lifespan` |   |
| content_guideline_chunks.jsonl | `guideline_content` |    |
| ecommerce_guideline_chunks.jsonl | `guideline_ecommerce` |   |

---

### 2.3  (dispute_resolution/)

** **: 4  
**  **: ~2,300  
****:      

#### 2.3.1 kca_final.jsonl ()

```json
{
  "source": "kca_merged",
  "agency": "kca",
  "case_no": "201527",
  "decision_date": "2015.05.11",
  "chunk_type": "decision|parties_claim|judgment",
  "text": "1.  2015. 7. 6...."
}
```

** **:
- **doc_id**: `kca:mediation:{case_no}` (: `kca:mediation:201527`)
- **doc_type**: `mediation_case`
- **title**: `{case_no} `
- **source_org**: `KCA`
- **chunk_id**: `kca:mediation:{case_no}:{chunk_type}:{seq}`
- **chunk_type**: `decision`, `parties_claim`, `judgment`
- **content**: `{text}`
- **metadata**: `{"case_no": "...", "decision_date": "...", "agency": "kca"}`

#### 2.3.2 ecmc_final_rag_chunks_normalized.jsonl ()

```json
{
  "source": "ecmc_merged",
  "agency": "ecmc",
  "case_no": "CA09-02073",
  "decision_date": "2009",
  "chunk_type": "decision|parties_claim",
  "text": " ...",
  "drop": false
}
```

** **:
- **doc_id**: `ecmc:mediation:{case_no}`
- **doc_type**: `mediation_case`
- **source_org**: `ECMC`
- **drop  **: `drop: true`   

#### 2.3.3 kcdrc_final_rag_chunks_normalized.jsonl ( )

- **source_org**: `KCDRC`
-  

---

### 2.4  (compensation_case/)

** **: 3  
**  **: ~15,000  
****:        

####  

```json
{
  "chunk_id": "consumer.go.kr:consumer_counsel_case:53321::chunk0",
  "chunk_index": 0,
  "chunk_total": 1,
  "doc_id": "consumer.go.kr:consumer_counsel_case:53321",
  "doc_type": "consumer_counsel_case",
  "title": "   ",
  "category_path": ["", ""],
  "text": "[] consumer_counsel_case\n[] ...\n[]\n...\n[]\n...",
  "metadata": {"case_sn": "53321", "url": "...", ...}
}
```

** **:
- **doc_id**:   ( )
- **doc_type**: `counsel_case`
- **source_org**: `consumer.go.kr`
- **chunk_id**:   ( )
- **chunk_type**: `qa_combined` (+ )
- **content**: `{text}`
- **category_path**:   ( )

---

## 3.   

### 3.1   

####   1: CHECK   

** ( 56)**:
```sql
CHECK (chunk_index >= 0 OR chunk_index >= 1)
```

****:
```sql
CHECK (chunk_index >= 0)  -- 0-based indexing 
```

####   2: doc_type  

**  **:
```sql
doc_type VARCHAR(50) NOT NULL,  -- 'law', 'counsel_case', 'mediation_case'
```

**  **:
- `law` 
- `mediation_case` 
- `counsel_case` 
- `criteria_item`   
- `criteria_resolution`   
- `criteria_warranty`   
- `criteria_lifespan`   
- `guideline_content`   
- `guideline_ecommerce`   

****:
```sql
doc_type VARCHAR(50) NOT NULL,  
-- 'law', 'mediation_case', 'counsel_case', 
-- 'criteria_item', 'criteria_resolution', 'criteria_warranty', 'criteria_lifespan',
-- 'guideline_content', 'guideline_ecommerce'
```

### 3.2   

```sql
--      
CREATE INDEX idx_documents_type_org ON documents(doc_type, source_org);

--    
CREATE INDEX idx_chunks_doc_type ON chunks(doc_id, chunk_type);

--   +  
CREATE INDEX idx_chunks_embedding_type ON chunks(chunk_type) 
WHERE embedding IS NOT NULL;
```

### 3.3   (schema_v2_final.sql)

```sql
-- ============================================
-- 1. documents 
-- ============================================
CREATE TABLE documents (
    doc_id VARCHAR(255) PRIMARY KEY,
    doc_type VARCHAR(50) NOT NULL,  
    title TEXT NOT NULL,
    source_org VARCHAR(100),  -- 'KCA', 'ECMC', 'KCDRC', 'statute', 'consumer.go.kr'
    category_path TEXT[],
    url TEXT,
    collected_at TIMESTAMP,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ============================================
-- 2. chunks 
-- ============================================
CREATE TABLE chunks (
    chunk_id VARCHAR(255) PRIMARY KEY,
    doc_id VARCHAR(255) NOT NULL REFERENCES documents(doc_id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    chunk_total INTEGER NOT NULL,
    chunk_type VARCHAR(50),
    content TEXT NOT NULL,
    content_length INTEGER,
    embedding vector(1024),
    embedding_model VARCHAR(50) DEFAULT 'KURE-v1',
    drop BOOLEAN DEFAULT FALSE,  --   (ecmc  )
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(doc_id, chunk_index),
    CHECK (chunk_index >= 0),  --  
    CHECK (chunk_total > 0),
    CHECK (chunk_index < chunk_total)
);
```

---

## 4.   

### 4.1   

```
[JSONL ] 
    ↓
[   ]
    ↓
[(documents) ]
    ↓
[(chunks) ]
    ↓
[ (chunk_relations) ]
    ↓
[PostgreSQL ]
```

### 4.2   

```python
# backend/scripts/data_processing/data_transform_pipeline.py

class DataTransformer:
    """  """
    
    def __init__(self, db_conn):
        self.conn = db_conn
        self.stats = {
            'documents': 0,
            'chunks': 0,
            'skipped': 0
        }
    
    def transform_law_data(self, file_path):
        """  """
        pass
    
    def transform_criteria_data(self, file_path, criteria_type):
        """  """
        pass
    
    def transform_mediation_data(self, file_path, agency):
        """ """
        pass
    
    def transform_counsel_data(self, file_path):
        """ """
        pass
```

### 4.3   

#### 4.3.1   

```python
def transform_law_data(self, file_path):
    """
      
    - : backend/data/law/*.jsonl
    -  :  (law_id)
    -  : /// (unit_id)
    """
    law_docs = {}  # {law_id: {chunks: []}}
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            law_id = data['law_id']
            
            #  
            if law_id not in law_docs:
                law_docs[law_id] = {
                    'doc_id': f"statute:{law_id}",
                    'doc_type': 'law',
                    'title': data['law_name'],
                    'source_org': 'statute',
                    'chunks': []
                }
            
            #  
            chunk = {
                'chunk_id': f"statute:{law_id}:{data['unit_id']}",
                'chunk_type': data['unit_level'],
                'content': f"[] {data['law_name']}\n[] {data['path']}\n\n{data['index_text']}"
            }
            law_docs[law_id]['chunks'].append(chunk)
    
    # DB 
    for law_id, doc_data in law_docs.items():
        self._insert_document(doc_data)
        self._insert_chunks(doc_data['doc_id'], doc_data['chunks'])
```

#### 4.3.2   

```python
def transform_criteria_table2(self, file_path):
    """
    table2 () 
    -  :   
    -  :  (row)
    """
    doc_id = 'criteria:table2'
    chunks = []
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for idx, line in enumerate(f):
            data = json.loads(line)
            
            # drop   ()
            if data.get('drop', False):
                self.stats['skipped'] += 1
                continue
            
            chunk = {
                'chunk_id': data['chunk_id'],
                'chunk_index': idx,
                'chunk_type': 'resolution_row',
                'content': data['text'],
                'category_path': [
                    data['category'],
                    data['item_group'],
                    data['item']
                ]
            }
            chunks.append(chunk)
    
    #  
    document = {
        'doc_id': doc_id,
        'doc_type': 'criteria_resolution',
        'title': ' -  ',
        'source_org': 'KCA'
    }
    
    # chunk_total 
    for chunk in chunks:
        chunk['chunk_total'] = len(chunks)
    
    self._insert_document(document)
    self._insert_chunks(doc_id, chunks)
```

#### 4.3.3  

```python
def transform_mediation_kca(self, file_path):
    """
    KCA  
    -  : (case_no)
    -  : chunk_type (decision, parties_claim, judgment)
    """
    cases = {}  # {case_no: {chunks: []}}
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            case_no = data['case_no']
            
            #  
            if case_no not in cases:
                cases[case_no] = {
                    'doc_id': f"kca:mediation:{case_no}",
                    'doc_type': 'mediation_case',
                    'title': f"{case_no} ",
                    'source_org': 'KCA',
                    'metadata': {
                        'case_no': case_no,
                        'decision_date': data.get('decision_date'),
                        'agency': 'kca'
                    },
                    'chunks': []
                }
            
            #  
            chunk = {
                'chunk_id': f"kca:mediation:{case_no}:{data['chunk_type']}:{len(cases[case_no]['chunks']):04d}",
                'chunk_type': data['chunk_type'],
                'content': data['text']
            }
            cases[case_no]['chunks'].append(chunk)
    
    # DB 
    for case_no, case_data in cases.items():
        self._insert_document(case_data)
        
        # chunk_index, chunk_total 
        chunks = case_data['chunks']
        for idx, chunk in enumerate(chunks):
            chunk['chunk_index'] = idx
            chunk['chunk_total'] = len(chunks)
        
        self._insert_chunks(case_data['doc_id'], chunks)
```

#### 4.3.4  

```python
def transform_counsel_case(self, file_path):
    """
     
    -  doc_id, chunk_id 
    -     
    """
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            
            #  
            document = {
                'doc_id': data['doc_id'],
                'doc_type': 'counsel_case',
                'title': data['title'],
                'source_org': 'consumer.go.kr',
                'category_path': data.get('category_path', []),
                'metadata': data.get('metadata', {})
            }
            self._insert_document(document)
            
            #  
            chunk = {
                'chunk_id': data['chunk_id'],
                'chunk_index': data['chunk_index'],
                'chunk_total': data['chunk_total'],
                'chunk_type': 'qa_combined',
                'content': data['text']
            }
            self._insert_chunks(data['doc_id'], [chunk])
```

### 4.4   

```python
def run_transformation():
    """   """
    transformer = DataTransformer(db_conn)
    
    # 1.  
    print("=" * 60)
    print("1.    ...")
    for law_file in glob.glob('backend/data/law/*.jsonl'):
        transformer.transform_law_data(law_file)
    
    # 2.  
    print("=" * 60)
    print("2.    ...")
    transformer.transform_criteria_table1('backend/data/criteria/table1_item_chunks.jsonl')
    transformer.transform_criteria_table2('backend/data/criteria/table2_resolution_row_chunks.jsonl')
    transformer.transform_criteria_table3('backend/data/criteria/table3_warranty_chunks.jsonl')
    transformer.transform_criteria_table4('backend/data/criteria/table4_lifespan_chunks.jsonl')
    transformer.transform_guideline('backend/data/criteria/content_guideline_chunks.jsonl', 'content')
    transformer.transform_guideline('backend/data/criteria/ecommerce_guideline_chunks.jsonl', 'ecommerce')
    
    # 3. 
    print("=" * 60)
    print("3.   ...")
    transformer.transform_mediation_kca('backend/data/dispute_resolution/kca_final.jsonl')
    transformer.transform_mediation_ecmc('backend/data/dispute_resolution/ecmc_final_rag_chunks_normalized.jsonl')
    transformer.transform_mediation_kcdrc('backend/data/dispute_resolution/kcdrc_final_rag_chunks_normalized.jsonl')
    
    # 4. 
    print("=" * 60)
    print("4.   ...")
    for counsel_file in glob.glob('backend/data/compensation_case/*.jsonl'):
        transformer.transform_counsel_case(counsel_file)
    
    #  
    print("=" * 60)
    print(" !")
    print(f"  - : {transformer.stats['documents']:,}")
    print(f"  - : {transformer.stats['chunks']:,}")
    print(f"  - : {transformer.stats['skipped']:,}")
```

---

## 5.  

### 5.1 1:     

```python
def determine_agency(user_query: str) -> str:
    """
         
    
    Returns:
        'KCA' | 'ECMC' | 'KCDRC'
    """
    # 1.   
    query_embedding = get_embedding(user_query)
    
    # 2. law + criteria 
    results = search_chunks(
        query_embedding,
        doc_types=['law', 'criteria_item', 'criteria_resolution'],
        top_k=10
    )
    
    # 3.      
    # - criteria category_path 
    # - law   
    # -   ( → ECMC,  → KCDRC,  → KCA)
    
    agency = analyze_domain(results)
    return agency
```

### 5.2 2:   

```python
def search_similar_cases(user_query: str, agency: str):
    """
        
      
    """
    query_embedding = get_embedding(user_query)
    
    # 1.   (  O)
    mediation_results = search_chunks(
        query_embedding,
        doc_types=['mediation_case'],
        source_org=agency,
        top_k=5,
        min_similarity=0.7
    )
    
    if len(mediation_results) >= 3:
        return mediation_results
    
    # 2.   (  X)
    counsel_results = search_chunks(
        query_embedding,
        doc_types=['counsel_case'],
        top_k=5,
        min_similarity=0.6
    )
    
    return mediation_results + counsel_results
```

### 5.3   

```sql
-- 1:   (law + criteria)
SELECT 
    c.chunk_id,
    c.content,
    d.doc_type,
    d.source_org,
    d.category_path,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type IN ('law', 'criteria_item', 'criteria_resolution')
  AND c.embedding IS NOT NULL
ORDER BY c.embedding <=> %s::vector
LIMIT 10;

-- 2:   ( )
SELECT 
    c.chunk_id,
    c.content,
    c.chunk_type,
    d.title,
    d.metadata,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type = 'mediation_case'
  AND d.source_org = %s  -- 'KCA', 'ECMC', 'KCDRC'
  AND c.embedding IS NOT NULL
  AND 1 - (c.embedding <=> %s::vector) >= 0.7
ORDER BY c.embedding <=> %s::vector
LIMIT 5;

-- 3:   (fallback)
SELECT 
    c.chunk_id,
    c.content,
    d.title,
    d.category_path,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type = 'counsel_case'
  AND c.embedding IS NOT NULL
  AND 1 - (c.embedding <=> %s::vector) >= 0.6
ORDER BY c.embedding <=> %s::vector
LIMIT 5;
```

---

## 6.  

### 6.1 Phase 1:    

** **:
1. `schema_v2.sql` 
   - CHECK   
   - doc_type  
   - drop  
   -  

2. `schema_v2_final.sql` 
3.  DB   

**  **: 1

### 6.2 Phase 2:    

** **:
1. `data_transform_pipeline.py` 
   -   
   -   
   -   
   -   

2.     
   - `visualize_transformation.py`
   - / 
   -   
   -   

**  **: 4

### 6.3 Phase 3:     

** **:
1.    
2.  
3.   
4.     

**  **: 2

### 6.4 Phase 4:  

** **:
1.  API  
2.   
3.   

**  **: 3 (   )

### 6.5 Phase 5:   

** **:
1. `retriever_v2.py` 
   -   
   -   
   -    

2.    
3.  

**  **: 4

---

## 7.    

### 7.1   

```python
# backend/scripts/visualize_transformation.py

class TransformationVisualizer:
    """   """
    
    def show_statistics(self):
        """  """
        # -   (doc_type)
        # -   (chunk_type)
        # -   
        # -  
    
    def show_sample_data(self, doc_type, n=5):
        """  """
        # -  doc_type  
        # -    
        # -   
    
    def plot_distribution(self):
        """  """
        # -    ( )
        # -    ()
        # -    ( )
    
    def validate_data(self):
        """ """
        # -   
        # -   
        # -  
```

### 7.2  

```
============================================================
   
============================================================

[ ]
    : 16,728
  
   :
    - law                    11
    - criteria_item           1
    - criteria_resolution     1
    - criteria_warranty       1
    - criteria_lifespan       1
    - guideline_content       1
    - guideline_ecommerce     1
    - mediation_case      1,158
    - counsel_case       15,553

[ ]
    : 32,456
  
   :
    - article              3,752
    - paragraph              248
    - item_classification    593
    - resolution_row         126
    - decision             1,158
    - parties_claim        1,158
    - judgment               856
    - qa_combined         15,553

[  ]
  - : 12
  - : 487
  - : 356
  - : 12,458

[ ]
  - statute           3,752
  - KCA              1,876
  - ECMC               368
  - KCDRC              124
  - consumer.go.kr  15,553

============================================================
  (law)
============================================================

[] statute:001706
  : 
   : 1,752
  
  [ 1] statute:001706:001706|A1
    : article
    : 87
    : [] 
          []  1
          
          1()     ...

============================================================
```

---

## 8. 

###   
- [ ] CHECK   
- [ ] doc_type  
- [ ] drop  
- [ ]  
- [ ]  

###   
- [ ]    
- [ ]    
- [ ]    
- [ ]    
- [ ]    

###  
- [ ]   
- [ ]   
- [ ]   
- [ ]  

###  
- [ ]  API  
- [ ]   
- [ ]   

###   
- [ ]   
- [ ]   
- [ ]    
- [ ]  

---

## 9.  

1. **   **
   -   
   -   

2. **    **
   - Phase 2 

3. **  **
   -   

4. ** **
   - Phase 4 

---

****: Manus AI  
** **: 2026-01-06
