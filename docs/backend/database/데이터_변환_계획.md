# 데이터 변환 및 스키마 계획서

**작성일**: 2026-01-06  
**프로젝트**: 똑소리 (ddoksori_demo)  
**목적**: RAG 시스템을 위한 데이터 변환 로직 및 스키마 최종 확정

---

## 📋 목차

1. [시스템 아키텍처 개요](#1-시스템-아키텍처-개요)
2. [데이터 분류 및 역할](#2-데이터-분류-및-역할)
3. [스키마 수정 사항](#3-스키마-수정-사항)
4. [데이터 변환 로직](#4-데이터-변환-로직)
5. [검색 전략](#5-검색-전략)
6. [구현 계획](#6-구현-계획)

---

## 1. 시스템 아키텍처 개요

### 1.1 RAG 파이프라인 플로우

```
[사용자 입력]
    ↓
[1단계: 도메인 파악]
    ├─ law (법령) 검색
    └─ criteria (기준) 검색
    ↓
[분쟁조정기관 확정: KCA/KCDRC/ECMC]
    ↓
[2단계: 유사 사례 검색]
    ├─ dispute_resolution (분쟁조정사례 - 실질 효력 O)
    └─ compensation_case (피해구제사례 - 실질 효력 X)
    ↓
[LLM 답변 생성]
```

### 1.2 데이터 계층 구조

| 계층 | 데이터 유형 | 역할 | 실질 효력 |
|-----|-----------|-----|---------|
| **Tier 1** | law + criteria | 도메인 파악 및 기관 확정 | 기준 |
| **Tier 2** | dispute_resolution | 유사 분쟁조정사례 제공 | ✅ 있음 |
| **Tier 3** | compensation_case | 유사 피해구제사례 제공 | ❌ 없음 |

---

## 2. 데이터 분류 및 역할

### 2.1 법령 데이터 (law/)

**파일 수**: 11개  
**총 라인 수**: ~4,000줄  
**역할**: 법적 근거 제공 및 도메인 분류

#### 데이터 구조
```json
{
  "unit_id": "001706|A1",
  "law_id": "001706",
  "law_name": "민법",
  "unit_level": "article|paragraph|item|subitem",
  "path": "민법 제1조",
  "article_no": "제1조",
  "index_text": "제1조(법원) 민사에 관하여...",
  "node_refs": ["001706|A1"],
  "source_type": "statute"
}
```

#### 매핑 전략
- **doc_id**: `statute:{law_id}` (예: `statute:001706`)
- **doc_type**: `law`
- **title**: `{law_name}`
- **source_org**: `statute`
- **chunk_id**: `statute:{law_id}:{unit_id}` (예: `statute:001706:001706|A1`)
- **chunk_type**: `{unit_level}` (article, paragraph, item, subitem)
- **content**: `[법령] {law_name}\n[조문] {path}\n\n{index_text}`

---

### 2.2 기준 데이터 (criteria/)

**파일 수**: 6개  
**총 라인 수**: ~900줄  
**역할**: 소비자분쟁해결기준 및 가이드라인 제공

#### 2.2.1 table1_item_chunks.jsonl (품목 분류)

```json
{
  "source": "table1",
  "record_type": "item_chunk",
  "stable_id": "table1:item:...",
  "embed_text": "계란\n분류: 농ㆍ수ㆍ축산물 / 란류\n카테고리: 상품(재화)",
  "metadata": {
    "item_name": "계란",
    "category": "상품(재화)",
    "industry": "농ㆍ수ㆍ축산물",
    "item_group": "란류"
  }
}
```

**매핑 전략**:
- **doc_id**: `criteria:table1`
- **doc_type**: `criteria_item`
- **title**: `소비자분쟁해결기준 - 대상품목`
- **source_org**: `KCA`
- **chunk_id**: `{stable_id}`
- **chunk_type**: `item_classification`
- **content**: `{embed_text}`
- **category_path**: `[{category}, {industry}, {item_group}]`

#### 2.2.2 table2_resolution_row_chunks.jsonl (해결기준)

```json
{
  "source": "table2",
  "chunk_type": "resolution_row",
  "chunk_id": "table2_row_p1_part1_4_1_...",
  "category": "I. 상품(재화)",
  "item_group": "1. 농-수 - 축산물(7개 업종)",
  "item": "1란류, 2육류...",
  "dispute_type": "함량, 용량, 중량, 개수 부족...",
  "resolution": "o 당해품목 교환 또는 구입가 환급",
  "laws": [{"law_name": "종자산업법", "law_id": "000422", ...}],
  "text": "category: ... | resolution: ..."
}
```

**매핑 전략**:
- **doc_id**: `criteria:table2`
- **doc_type**: `criteria_resolution`
- **title**: `소비자분쟁해결기준 - 품목별 해결기준`
- **source_org**: `KCA`
- **chunk_id**: `{chunk_id}` (그대로 사용)
- **chunk_type**: `resolution_row`
- **content**: `{text}`
- **category_path**: `[{category}, {item_group}, {item}]`
- **metadata**: laws 배열을 JSONB로 저장

#### 2.2.3 기타 기준 파일

| 파일 | doc_type | 역할 |
|-----|----------|-----|
| table3_warranty_chunks.jsonl | `criteria_warranty` | 품목별 보증기간 |
| table4_lifespan_chunks.jsonl | `criteria_lifespan` | 품목별 내용연수 |
| content_guideline_chunks.jsonl | `guideline_content` | 콘텐츠 이용자 보호지침 |
| ecommerce_guideline_chunks.jsonl | `guideline_ecommerce` | 전자상거래 가이드라인 |

---

### 2.3 분쟁조정사례 (dispute_resolution/)

**파일 수**: 4개  
**총 라인 수**: ~2,300줄  
**역할**: 실질 효력이 있는 분쟁조정 결정례 제공

#### 2.3.1 kca_final.jsonl (한국소비자원)

```json
{
  "source": "kca_merged",
  "agency": "kca",
  "case_no": "2015일가27",
  "decision_date": "2015.05.11",
  "chunk_type": "decision|parties_claim|judgment",
  "text": "1. 피신청인은 2015. 7. 6.까지..."
}
```

**매핑 전략**:
- **doc_id**: `kca:mediation:{case_no}` (예: `kca:mediation:2015일가27`)
- **doc_type**: `mediation_case`
- **title**: `{case_no} 분쟁조정사례`
- **source_org**: `KCA`
- **chunk_id**: `kca:mediation:{case_no}:{chunk_type}:{seq}`
- **chunk_type**: `decision`, `parties_claim`, `judgment`
- **content**: `{text}`
- **metadata**: `{"case_no": "...", "decision_date": "...", "agency": "kca"}`

#### 2.3.2 ecmc_final_rag_chunks_normalized.jsonl (한국전자거래분쟁조정위원회)

```json
{
  "source": "ecmc_merged",
  "agency": "ecmc",
  "case_no": "CA09-02073",
  "decision_date": "2009",
  "chunk_type": "decision|parties_claim",
  "text": "피신청인은 신청인에게...",
  "drop": false
}
```

**매핑 전략**:
- **doc_id**: `ecmc:mediation:{case_no}`
- **doc_type**: `mediation_case`
- **source_org**: `ECMC`
- **drop 필드 처리**: `drop: true`인 청크는 삽입하지 않음

#### 2.3.3 kcdrc_final_rag_chunks_normalized.jsonl (한국소비자원 지역분쟁조정위원회)

- **source_org**: `KCDRC`
- 나머지는 동일

---

### 2.4 피해구제사례 (compensation_case/)

**파일 수**: 3개  
**총 라인 수**: ~15,000줄  
**역할**: 실질 효력은 없지만 참고할 수 있는 상담사례 제공

#### 데이터 구조

```json
{
  "chunk_id": "consumer.go.kr:consumer_counsel_case:53321::chunk0",
  "chunk_index": 0,
  "chunk_total": 1,
  "doc_id": "consumer.go.kr:consumer_counsel_case:53321",
  "doc_type": "consumer_counsel_case",
  "title": "가전제품 정액감가상각 계산법 문의",
  "category_path": ["기계류기타물품", "기타미분류물품"],
  "text": "[문서유형] consumer_counsel_case\n[제목] ...\n[질문]\n...\n[답변]\n...",
  "metadata": {"case_sn": "53321", "url": "...", ...}
}
```

**매핑 전략**:
- **doc_id**: 이미 존재 (그대로 사용)
- **doc_type**: `counsel_case`
- **source_org**: `consumer.go.kr`
- **chunk_id**: 이미 존재 (그대로 사용)
- **chunk_type**: `qa_combined` (질문+답변 통합)
- **content**: `{text}`
- **category_path**: 이미 존재 (그대로 사용)

---

## 3. 스키마 수정 사항

### 3.1 필수 수정 사항

#### ❌ 문제 1: CHECK 제약 조건 오류

**현재 (라인 56)**:
```sql
CHECK (chunk_index >= 0 OR chunk_index >= 1)
```

**수정**:
```sql
CHECK (chunk_index >= 0)  -- 0-based indexing 채택
```

#### ❌ 문제 2: doc_type 값 불일치

**현재 스키마 주석**:
```sql
doc_type VARCHAR(50) NOT NULL,  -- 'law', 'counsel_case', 'mediation_case'
```

**실제 필요한 값**:
- `law` ✅
- `mediation_case` ✅
- `counsel_case` ✅
- `criteria_item` ⚠️ 추가 필요
- `criteria_resolution` ⚠️ 추가 필요
- `criteria_warranty` ⚠️ 추가 필요
- `criteria_lifespan` ⚠️ 추가 필요
- `guideline_content` ⚠️ 추가 필요
- `guideline_ecommerce` ⚠️ 추가 필요

**수정**:
```sql
doc_type VARCHAR(50) NOT NULL,  
-- 'law', 'mediation_case', 'counsel_case', 
-- 'criteria_item', 'criteria_resolution', 'criteria_warranty', 'criteria_lifespan',
-- 'guideline_content', 'guideline_ecommerce'
```

### 3.2 인덱스 추가 제안

```sql
-- 검색 성능 향상을 위한 복합 인덱스
CREATE INDEX idx_documents_type_org ON documents(doc_type, source_org);

-- 청크 타입별 검색 최적화
CREATE INDEX idx_chunks_doc_type ON chunks(doc_id, chunk_type);

-- 벡터 검색 + 필터링 최적화
CREATE INDEX idx_chunks_embedding_type ON chunks(chunk_type) 
WHERE embedding IS NOT NULL;
```

### 3.3 최종 스키마 (schema_v2_final.sql)

```sql
-- ============================================
-- 1. documents 테이블
-- ============================================
CREATE TABLE documents (
    doc_id VARCHAR(255) PRIMARY KEY,
    doc_type VARCHAR(50) NOT NULL,  
    title TEXT NOT NULL,
    source_org VARCHAR(100),  -- 'KCA', 'ECMC', 'KCDRC', 'statute', 'consumer.go.kr'
    category_path TEXT[],
    url TEXT,
    collected_at TIMESTAMP,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ============================================
-- 2. chunks 테이블
-- ============================================
CREATE TABLE chunks (
    chunk_id VARCHAR(255) PRIMARY KEY,
    doc_id VARCHAR(255) NOT NULL REFERENCES documents(doc_id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    chunk_total INTEGER NOT NULL,
    chunk_type VARCHAR(50),
    content TEXT NOT NULL,
    content_length INTEGER,
    embedding vector(1024),
    embedding_model VARCHAR(50) DEFAULT 'KURE-v1',
    drop BOOLEAN DEFAULT FALSE,  -- 삭제 플래그 (ecmc 등에서 사용)
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(doc_id, chunk_index),
    CHECK (chunk_index >= 0),  -- ✅ 수정됨
    CHECK (chunk_total > 0),
    CHECK (chunk_index < chunk_total)
);
```

---

## 4. 데이터 변환 로직

### 4.1 변환 파이프라인 구조

```
[JSONL 파일] 
    ↓
[데이터 로드 및 파싱]
    ↓
[문서(documents) 생성]
    ↓
[청크(chunks) 생성]
    ↓
[청크 관계(chunk_relations) 생성]
    ↓
[PostgreSQL 삽입]
```

### 4.2 변환 스크립트 구조

```python
# backend/scripts/data_processing/data_transform_pipeline.py

class DataTransformer:
    """데이터 변환 파이프라인"""
    
    def __init__(self, db_conn):
        self.conn = db_conn
        self.stats = {
            'documents': 0,
            'chunks': 0,
            'skipped': 0
        }
    
    def transform_law_data(self, file_path):
        """법령 데이터 변환"""
        pass
    
    def transform_criteria_data(self, file_path, criteria_type):
        """기준 데이터 변환"""
        pass
    
    def transform_mediation_data(self, file_path, agency):
        """분쟁조정사례 변환"""
        pass
    
    def transform_counsel_data(self, file_path):
        """피해구제사례 변환"""
        pass
```

### 4.3 상세 변환 로직

#### 4.3.1 법령 데이터 변환

```python
def transform_law_data(self, file_path):
    """
    법령 데이터 변환
    - 파일: backend/data/law/*.jsonl
    - 문서 단위: 법령별 (law_id)
    - 청크 단위: 조문/항/호/목별 (unit_id)
    """
    law_docs = {}  # {law_id: {chunks: []}}
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            law_id = data['law_id']
            
            # 문서 그룹화
            if law_id not in law_docs:
                law_docs[law_id] = {
                    'doc_id': f"statute:{law_id}",
                    'doc_type': 'law',
                    'title': data['law_name'],
                    'source_org': 'statute',
                    'chunks': []
                }
            
            # 청크 생성
            chunk = {
                'chunk_id': f"statute:{law_id}:{data['unit_id']}",
                'chunk_type': data['unit_level'],
                'content': f"[법령] {data['law_name']}\n[조문] {data['path']}\n\n{data['index_text']}"
            }
            law_docs[law_id]['chunks'].append(chunk)
    
    # DB 삽입
    for law_id, doc_data in law_docs.items():
        self._insert_document(doc_data)
        self._insert_chunks(doc_data['doc_id'], doc_data['chunks'])
```

#### 4.3.2 기준 데이터 변환

```python
def transform_criteria_table2(self, file_path):
    """
    table2 (해결기준) 변환
    - 문서 단위: 전체를 하나의 문서로
    - 청크 단위: 각 행(row)
    """
    doc_id = 'criteria:table2'
    chunks = []
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for idx, line in enumerate(f):
            data = json.loads(line)
            
            # drop 플래그 확인 (있다면)
            if data.get('drop', False):
                self.stats['skipped'] += 1
                continue
            
            chunk = {
                'chunk_id': data['chunk_id'],
                'chunk_index': idx,
                'chunk_type': 'resolution_row',
                'content': data['text'],
                'category_path': [
                    data['category'],
                    data['item_group'],
                    data['item']
                ]
            }
            chunks.append(chunk)
    
    # 문서 생성
    document = {
        'doc_id': doc_id,
        'doc_type': 'criteria_resolution',
        'title': '소비자분쟁해결기준 - 품목별 해결기준',
        'source_org': 'KCA'
    }
    
    # chunk_total 설정
    for chunk in chunks:
        chunk['chunk_total'] = len(chunks)
    
    self._insert_document(document)
    self._insert_chunks(doc_id, chunks)
```

#### 4.3.3 분쟁조정사례 변환

```python
def transform_mediation_kca(self, file_path):
    """
    KCA 분쟁조정사례 변환
    - 문서 단위: 사건번호(case_no)별
    - 청크 단위: chunk_type별 (decision, parties_claim, judgment)
    """
    cases = {}  # {case_no: {chunks: []}}
    
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            case_no = data['case_no']
            
            # 문서 그룹화
            if case_no not in cases:
                cases[case_no] = {
                    'doc_id': f"kca:mediation:{case_no}",
                    'doc_type': 'mediation_case',
                    'title': f"{case_no} 분쟁조정사례",
                    'source_org': 'KCA',
                    'metadata': {
                        'case_no': case_no,
                        'decision_date': data.get('decision_date'),
                        'agency': 'kca'
                    },
                    'chunks': []
                }
            
            # 청크 생성
            chunk = {
                'chunk_id': f"kca:mediation:{case_no}:{data['chunk_type']}:{len(cases[case_no]['chunks']):04d}",
                'chunk_type': data['chunk_type'],
                'content': data['text']
            }
            cases[case_no]['chunks'].append(chunk)
    
    # DB 삽입
    for case_no, case_data in cases.items():
        self._insert_document(case_data)
        
        # chunk_index, chunk_total 설정
        chunks = case_data['chunks']
        for idx, chunk in enumerate(chunks):
            chunk['chunk_index'] = idx
            chunk['chunk_total'] = len(chunks)
        
        self._insert_chunks(case_data['doc_id'], chunks)
```

#### 4.3.4 피해구제사례 변환

```python
def transform_counsel_case(self, file_path):
    """
    피해구제사례 변환
    - 이미 doc_id, chunk_id가 존재
    - 그대로 사용하되 필요한 필드만 추출
    """
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            data = json.loads(line)
            
            # 문서 생성
            document = {
                'doc_id': data['doc_id'],
                'doc_type': 'counsel_case',
                'title': data['title'],
                'source_org': 'consumer.go.kr',
                'category_path': data.get('category_path', []),
                'metadata': data.get('metadata', {})
            }
            self._insert_document(document)
            
            # 청크 생성
            chunk = {
                'chunk_id': data['chunk_id'],
                'chunk_index': data['chunk_index'],
                'chunk_total': data['chunk_total'],
                'chunk_type': 'qa_combined',
                'content': data['text']
            }
            self._insert_chunks(data['doc_id'], [chunk])
```

### 4.4 변환 실행 순서

```python
def run_transformation():
    """전체 데이터 변환 실행"""
    transformer = DataTransformer(db_conn)
    
    # 1. 법령 데이터
    print("=" * 60)
    print("1. 법령 데이터 변환 중...")
    for law_file in glob.glob('backend/data/law/*.jsonl'):
        transformer.transform_law_data(law_file)
    
    # 2. 기준 데이터
    print("=" * 60)
    print("2. 기준 데이터 변환 중...")
    transformer.transform_criteria_table1('backend/data/criteria/table1_item_chunks.jsonl')
    transformer.transform_criteria_table2('backend/data/criteria/table2_resolution_row_chunks.jsonl')
    transformer.transform_criteria_table3('backend/data/criteria/table3_warranty_chunks.jsonl')
    transformer.transform_criteria_table4('backend/data/criteria/table4_lifespan_chunks.jsonl')
    transformer.transform_guideline('backend/data/criteria/content_guideline_chunks.jsonl', 'content')
    transformer.transform_guideline('backend/data/criteria/ecommerce_guideline_chunks.jsonl', 'ecommerce')
    
    # 3. 분쟁조정사례
    print("=" * 60)
    print("3. 분쟁조정사례 변환 중...")
    transformer.transform_mediation_kca('backend/data/dispute_resolution/kca_final.jsonl')
    transformer.transform_mediation_ecmc('backend/data/dispute_resolution/ecmc_final_rag_chunks_normalized.jsonl')
    transformer.transform_mediation_kcdrc('backend/data/dispute_resolution/kcdrc_final_rag_chunks_normalized.jsonl')
    
    # 4. 피해구제사례
    print("=" * 60)
    print("4. 피해구제사례 변환 중...")
    for counsel_file in glob.glob('backend/data/compensation_case/*.jsonl'):
        transformer.transform_counsel_case(counsel_file)
    
    # 통계 출력
    print("=" * 60)
    print("변환 완료!")
    print(f"  - 문서: {transformer.stats['documents']:,}개")
    print(f"  - 청크: {transformer.stats['chunks']:,}개")
    print(f"  - 스킵: {transformer.stats['skipped']:,}개")
```

---

## 5. 검색 전략

### 5.1 1단계: 도메인 파악 및 기관 확정

```python
def determine_agency(user_query: str) -> str:
    """
    사용자 쿼리를 기반으로 관할 분쟁조정기관 확정
    
    Returns:
        'KCA' | 'ECMC' | 'KCDRC'
    """
    # 1. 쿼리 임베딩 생성
    query_embedding = get_embedding(user_query)
    
    # 2. law + criteria 검색
    results = search_chunks(
        query_embedding,
        doc_types=['law', 'criteria_item', 'criteria_resolution'],
        top_k=10
    )
    
    # 3. 검색 결과 기반 기관 확정 로직
    # - criteria의 category_path 분석
    # - law의 관련 법령 분석
    # - 키워드 매칭 (전자상거래 → ECMC, 지역 → KCDRC, 기타 → KCA)
    
    agency = analyze_domain(results)
    return agency
```

### 5.2 2단계: 유사 사례 검색

```python
def search_similar_cases(user_query: str, agency: str):
    """
    확정된 기관의 분쟁조정사례 우선 검색
    없으면 피해구제사례 검색
    """
    query_embedding = get_embedding(user_query)
    
    # 1. 분쟁조정사례 검색 (실질 효력 O)
    mediation_results = search_chunks(
        query_embedding,
        doc_types=['mediation_case'],
        source_org=agency,
        top_k=5,
        min_similarity=0.7
    )
    
    if len(mediation_results) >= 3:
        return mediation_results
    
    # 2. 피해구제사례 검색 (실질 효력 X)
    counsel_results = search_chunks(
        query_embedding,
        doc_types=['counsel_case'],
        top_k=5,
        min_similarity=0.6
    )
    
    return mediation_results + counsel_results
```

### 5.3 검색 쿼리 예시

```sql
-- 1단계: 도메인 파악 (law + criteria)
SELECT 
    c.chunk_id,
    c.content,
    d.doc_type,
    d.source_org,
    d.category_path,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type IN ('law', 'criteria_item', 'criteria_resolution')
  AND c.embedding IS NOT NULL
ORDER BY c.embedding <=> %s::vector
LIMIT 10;

-- 2단계: 분쟁조정사례 검색 (기관 필터링)
SELECT 
    c.chunk_id,
    c.content,
    c.chunk_type,
    d.title,
    d.metadata,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type = 'mediation_case'
  AND d.source_org = %s  -- 'KCA', 'ECMC', 'KCDRC'
  AND c.embedding IS NOT NULL
  AND 1 - (c.embedding <=> %s::vector) >= 0.7
ORDER BY c.embedding <=> %s::vector
LIMIT 5;

-- 3단계: 피해구제사례 검색 (fallback)
SELECT 
    c.chunk_id,
    c.content,
    d.title,
    d.category_path,
    1 - (c.embedding <=> %s::vector) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE d.doc_type = 'counsel_case'
  AND c.embedding IS NOT NULL
  AND 1 - (c.embedding <=> %s::vector) >= 0.6
ORDER BY c.embedding <=> %s::vector
LIMIT 5;
```

---

## 6. 구현 계획

### 6.1 Phase 1: 스키마 수정 및 확정

**작업 내용**:
1. `schema_v2.sql` 수정
   - CHECK 제약 조건 수정
   - doc_type 주석 업데이트
   - drop 컬럼 추가
   - 인덱스 추가

2. `schema_v2_final.sql` 생성
3. 테스트 DB에 적용 및 검증

**예상 소요 시간**: 1시간

### 6.2 Phase 2: 데이터 변환 스크립트 작성

**작업 내용**:
1. `data_transform_pipeline.py` 작성
   - 법령 변환 로직
   - 기준 변환 로직
   - 분쟁조정사례 변환 로직
   - 피해구제사례 변환 로직

2. 변환 결과 시각화 스크립트 작성
   - `visualize_transformation.py`
   - 문서/청크 통계
   - 데이터 분포 그래프
   - 샘플 데이터 출력

**예상 소요 시간**: 4시간

### 6.3 Phase 3: 데이터 변환 실행 및 검증

**작업 내용**:
1. 전체 데이터 변환 실행
2. 통계 확인
3. 샘플 데이터 검증
4. 이상 데이터 확인 및 수정

**예상 소요 시간**: 2시간

### 6.4 Phase 4: 임베딩 생성

**작업 내용**:
1. 임베딩 API 서버 실행
2. 배치 임베딩 생성
3. 임베딩 품질 검증

**예상 소요 시간**: 3시간 (데이터 크기에 따라 변동)

### 6.5 Phase 5: 검색 로직 구현

**작업 내용**:
1. `retriever_v2.py` 작성
   - 도메인 파악 함수
   - 기관 확정 함수
   - 유사 사례 검색 함수

2. 검색 테스트 케이스 작성
3. 성능 최적화

**예상 소요 시간**: 4시간

---

## 7. 데이터 변환 결과 시각화

### 7.1 시각화 스크립트 구조

```python
# backend/scripts/visualize_transformation.py

class TransformationVisualizer:
    """데이터 변환 결과 시각화"""
    
    def show_statistics(self):
        """전체 통계 출력"""
        # - 문서 수 (doc_type별)
        # - 청크 수 (chunk_type별)
        # - 평균 청크 길이
        # - 데이터 분포
    
    def show_sample_data(self, doc_type, n=5):
        """샘플 데이터 출력"""
        # - 각 doc_type별 샘플 문서
        # - 각 문서의 청크 구조
        # - 청크 내용 미리보기
    
    def plot_distribution(self):
        """데이터 분포 그래프"""
        # - 문서 유형별 분포 (파이 차트)
        # - 청크 길이 분포 (히스토그램)
        # - 출처별 데이터 수 (막대 그래프)
    
    def validate_data(self):
        """데이터 검증"""
        # - 누락된 필드 확인
        # - 중복 데이터 확인
        # - 이상치 확인
```

### 7.2 출력 예시

```
============================================================
데이터 변환 결과 통계
============================================================

[문서 통계]
  총 문서 수: 16,728개
  
  문서 유형별:
    - law                    11개
    - criteria_item           1개
    - criteria_resolution     1개
    - criteria_warranty       1개
    - criteria_lifespan       1개
    - guideline_content       1개
    - guideline_ecommerce     1개
    - mediation_case      1,158개
    - counsel_case       15,553개

[청크 통계]
  총 청크 수: 32,456개
  
  청크 유형별:
    - article              3,752개
    - paragraph              248개
    - item_classification    593개
    - resolution_row         126개
    - decision             1,158개
    - parties_claim        1,158개
    - judgment               856개
    - qa_combined         15,553개

[청크 길이 통계]
  - 최소: 12자
  - 평균: 487자
  - 중앙값: 356자
  - 최대: 12,458자

[출처별 통계]
  - statute           3,752개
  - KCA              1,876개
  - ECMC               368개
  - KCDRC              124개
  - consumer.go.kr  15,553개

============================================================
샘플 데이터 (law)
============================================================

[문서] statute:001706
  제목: 민법
  청크 수: 1,752개
  
  [청크 1] statute:001706:001706|A1
    타입: article
    길이: 87자
    내용: [법령] 민법
          [조문] 민법 제1조
          
          제1조(법원) 민사에 관하여 법률에 규정이 없으면...

============================================================
```

---

## 8. 체크리스트

### ✅ 스키마 확정
- [ ] CHECK 제약 조건 수정
- [ ] doc_type 값 확장
- [ ] drop 컬럼 추가
- [ ] 인덱스 추가
- [ ] 스키마 테스트

### ✅ 데이터 변환
- [ ] 법령 변환 로직 작성
- [ ] 기준 변환 로직 작성
- [ ] 분쟁조정사례 변환 로직 작성
- [ ] 피해구제사례 변환 로직 작성
- [ ] 변환 실행 및 검증

### ✅ 시각화
- [ ] 통계 출력 스크립트
- [ ] 샘플 데이터 출력
- [ ] 분포 그래프 생성
- [ ] 데이터 검증

### ✅ 임베딩
- [ ] 임베딩 API 서버 실행
- [ ] 배치 임베딩 생성
- [ ] 임베딩 품질 검증

### ✅ 검색 로직
- [ ] 도메인 파악 함수
- [ ] 기관 확정 함수
- [ ] 유사 사례 검색 함수
- [ ] 검색 테스트

---

## 9. 다음 단계

1. **스키마 수정 승인 요청**
   - 현재 계획서 검토
   - 수정 사항 확인

2. **데이터 변환 스크립트 작성 시작**
   - Phase 2 진행

3. **변환 결과 시각화**
   - 데이터 품질 확인

4. **임베딩 생성**
   - Phase 4 진행

---

**작성자**: Manus AI  
**최종 수정**: 2026-01-06
