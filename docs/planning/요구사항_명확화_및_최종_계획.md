# 요구사항 명확화 및 최종 계획

**작성일**: 2026-01-06  
**프로젝트**: 똑소리 (ddoksori_demo)

---

## 📋 요구사항 명확화 (Clarification)

### 사용자 제공 정보

#### 1. 데이터 사용 목적

| 데이터 | 역할 | 실질 효력 |
|--------|------|----------|
| **law/** (법령) | 법령과 함께 사용자의 현재 도메인 파악 | 기준 |
| **criteria/** (기준) | 기준과 함께 사용자의 현재 도메인 파악 | 기준 |
| **dispute_resolution/** (분쟁조정사례) | 현재 사용자의 상황과 유사한 사례 제공 | ✅ 있음 |
| **compensation_case/** (피해구제사례) | 현재 사용자의 상황과 유사한 사례 제공 | ❌ 없음 |

#### 2. RAG 플로우

```
[사용자 입력]
    ↓
[law + criteria 검색]
    ↓
[분쟁조정기관 확정: KCA/KCDRC/ECMC]
    ↓
[유사 분쟁조정사례 검색]
    ↓
[없다면 → 유사 피해구제사례 검색]
    ↓
[LLM 답변 생성]
```

---

## ✅ 확정된 사항

### 1. 스키마 수정 사항

#### ✅ 수정 완료
- **CHECK 제약 조건 수정**: `chunk_index >= 0` (0-based indexing)
- **doc_type 확장**: criteria, guideline 유형 추가
- **drop 컬럼 추가**: 삭제 플래그 (검색 제외용)
- **복합 인덱스 추가**: 검색 성능 최적화
- **search_similar_chunks 함수 개선**: 다중 필터 지원 (doc_type, chunk_type, source_org, min_similarity)

#### 📄 파일
- `/home/maroco/ddoksori_demo/backend/database/schema_v2_final.sql`

---

### 2. 데이터 변환 전략

#### 2.1 문서 단위 정의

| 데이터 유형 | 문서 단위 | 예시 doc_id |
|-----------|---------|------------|
| **law** | 법령별 (law_id) | `statute:001706` (민법) |
| **criteria_item** | 전체 테이블 하나 | `criteria:table1` |
| **criteria_resolution** | 전체 테이블 하나 | `criteria:table2` |
| **mediation_case** | 사건번호별 (case_no) | `kca:mediation:2015일가27` |
| **counsel_case** | 이미 정의됨 | `consumer.go.kr:consumer_counsel_case:53321` |

#### 2.2 청크 인덱싱 규칙

- **chunk_index**: **0부터 시작** (0-based indexing)
- **chunk_total**: 해당 문서 내 전체 청크 개수
- **chunk_id 형식**: `{source}:{doc_type}:{identifier}:{chunk_type}:{index}`

#### 2.3 임베딩 생성 시점

- **스키마 생성 및 데이터 변환 완료 후** 별도 프로세스로 진행
- 임베딩 API 서버 사용 (KURE-v1 모델)
- 배치 크기: 32~64

#### 2.4 관련 법령 데이터 처리

- `table2_resolution_row_chunks.jsonl`의 `laws` 배열
- **metadata JSONB에 포함**하여 저장
- 필요 시 JSONB 쿼리로 검색 가능

#### 2.5 drop 플래그 처리

- `ecmc_final_rag_chunks_normalized.jsonl` 등에서 `drop: true`인 청크
- **DB에는 삽입하되 drop=TRUE로 설정**
- 검색 시 `WHERE drop = FALSE` 조건으로 제외

---

### 3. 데이터 변환 로직

#### 3.1 변환 파이프라인

```
[JSONL 파일 로드]
    ↓
[문서(documents) 생성]
    ├─ doc_id 생성
    ├─ doc_type 매핑
    ├─ category_path 변환
    └─ metadata 구성
    ↓
[청크(chunks) 생성]
    ├─ chunk_id 생성
    ├─ chunk_index 할당 (0부터)
    ├─ chunk_total 계산
    └─ content 구성
    ↓
[PostgreSQL 삽입]
    ├─ documents 테이블
    └─ chunks 테이블
```

#### 3.2 주요 변환 함수

```python
class DataTransformer:
    def transform_law_data(file_path)
    def transform_criteria_table1(file_path)
    def transform_criteria_table2(file_path)
    def transform_mediation_kca(file_path)
    def transform_mediation_ecmc(file_path)
    def transform_counsel_case(file_path)
```

#### 3.3 실행 순서

1. **법령 데이터** (11개 파일)
2. **기준 데이터** (6개 파일)
3. **분쟁조정사례** (3개 파일)
4. **피해구제사례** (3개 파일)

---

### 4. 검색 전략

#### 4.1 1단계: 도메인 파악 및 기관 확정

```python
def determine_agency(user_query: str) -> str:
    """
    law + criteria 검색 결과를 기반으로 관할 기관 확정
    
    Returns:
        'KCA' | 'ECMC' | 'KCDRC'
    """
    query_embedding = get_embedding(user_query)
    
    # law + criteria 검색
    results = search_similar_chunks(
        query_embedding,
        doc_type_filter=['law', 'criteria_item', 'criteria_resolution'],
        top_k=10
    )
    
    # 검색 결과 분석하여 기관 확정
    agency = analyze_domain(results)
    return agency
```

**기관 확정 로직**:
- **ECMC**: 전자상거래, 통신판매 관련 키워드
- **KCDRC**: 지역 기반 분쟁 (지역 키워드)
- **KCA**: 기타 모든 소비자 분쟁

#### 4.2 2단계: 유사 사례 검색

```python
def search_similar_cases(user_query: str, agency: str):
    """
    확정된 기관의 분쟁조정사례 우선 검색
    충분하지 않으면 피해구제사례 검색
    """
    query_embedding = get_embedding(user_query)
    
    # 1. 분쟁조정사례 검색 (실질 효력 O)
    mediation_results = search_similar_chunks(
        query_embedding,
        doc_type_filter='mediation_case',
        source_org_filter=agency,
        top_k=5,
        min_similarity=0.7
    )
    
    if len(mediation_results) >= 3:
        return mediation_results
    
    # 2. 피해구제사례 검색 (실질 효력 X)
    counsel_results = search_similar_chunks(
        query_embedding,
        doc_type_filter='counsel_case',
        top_k=5,
        min_similarity=0.6
    )
    
    return mediation_results + counsel_results
```

---

### 5. 시각화 도구

#### 5.1 시각화 스크립트

**파일**: `/home/maroco/ddoksori_demo/backend/scripts/visualize_transformation.py`

**기능**:
1. **전체 통계**: 문서/청크 수, 유형별 분포
2. **청크 길이 통계**: 최소/평균/중앙값/최대
3. **출처별 통계**: 기관별 데이터 분포
4. **임베딩 통계**: 임베딩 완료율
5. **샘플 데이터**: 각 유형별 샘플 출력
6. **데이터 검증**: 인덱스, 중복, NULL, 이상치 확인

#### 5.2 실행 방법

```bash
cd /home/maroco/ddoksori_demo/backend
conda activate ddoksori
python scripts/visualize_transformation.py
```

#### 5.3 출력 예시

```
================================================================================
                          데이터 변환 결과 통계
================================================================================

--------------------------------------------------------------------------------
[문서 통계]
--------------------------------------------------------------------------------
  총 문서 수: 16,728개

  문서 유형별:
    - counsel_case                   15,553개
    - mediation_case                  1,158개
    - law                                11개
    - criteria_item                       1개
    - criteria_resolution                 1개
    ...

--------------------------------------------------------------------------------
[청크 통계]
--------------------------------------------------------------------------------
  총 청크 수: 32,456개
    - 활성 청크: 31,298개
    - 비활성 청크: 1,158개

  청크 유형별:
    - qa_combined                    15,553개
    - article                         3,752개
    - decision                        1,158개
    - parties_claim                   1,158개
    ...
```

---

## 📊 예상 데이터 규모

### 파일별 데이터 규모

| 폴더 | 파일 수 | 총 라인 수 | 예상 문서 수 | 예상 청크 수 |
|-----|--------|-----------|------------|------------|
| **law/** | 11 | ~4,000 | 11 | ~4,000 |
| **criteria/** | 6 | ~900 | 6 | ~900 |
| **dispute_resolution/** | 4 | ~2,300 | ~1,500 | ~3,000 |
| **compensation_case/** | 3 | ~15,000 | ~15,000 | ~15,000 |
| **합계** | **24** | **~22,200** | **~16,517** | **~22,900** |

---

## 🔧 구현 계획

### Phase 1: 스키마 적용 ✅ 완료

- [x] `schema_v2_final.sql` 작성
- [x] CHECK 제약 조건 수정
- [x] doc_type 확장
- [x] drop 컬럼 추가
- [x] 복합 인덱스 추가
- [x] search_similar_chunks 함수 개선

### Phase 2: 데이터 변환 스크립트 작성 (다음 단계)

**작업 내용**:
1. `data_transform_pipeline.py` 작성
   - [ ] 법령 변환 로직
   - [ ] 기준 변환 로직 (table1, table2, table3, table4, guideline)
   - [ ] 분쟁조정사례 변환 로직 (KCA, ECMC, KCDRC)
   - [ ] 피해구제사례 변환 로직

2. 변환 실행 및 검증
   - [ ] 전체 데이터 변환 실행
   - [ ] 시각화 스크립트로 결과 확인
   - [ ] 이상 데이터 수정

**예상 소요 시간**: 4~6시간

### Phase 3: 임베딩 생성 (Phase 2 완료 후)

**작업 내용**:
1. 임베딩 API 서버 실행
2. 배치 임베딩 생성
3. 임베딩 품질 검증

**예상 소요 시간**: 3~4시간 (데이터 크기에 따라 변동)

### Phase 4: 검색 로직 구현 (Phase 3 완료 후)

**작업 내용**:
1. `retriever_v2.py` 작성
   - [ ] 도메인 파악 함수
   - [ ] 기관 확정 함수
   - [ ] 유사 사례 검색 함수

2. 검색 테스트 케이스 작성
3. 성능 최적화

**예상 소요 시간**: 4~5시간

---

## 📝 다음 단계 액션 아이템

### 즉시 실행 가능

1. **스키마 적용**
   ```bash
   cd /home/maroco/ddoksori_demo
   docker-compose up -d
   docker exec -it ddoksori_db psql -U postgres -d ddoksori -f /schema/schema_v2_final.sql
   ```

2. **데이터 변환 스크립트 작성 시작**
   - `backend/scripts/data_processing/data_transform_pipeline.py` 작성
   - 법령 데이터부터 시작

3. **변환 결과 확인**
   ```bash
   conda activate ddoksori
   python backend/scripts/visualize_transformation.py
   ```

### 확인 필요 사항

#### Q1. 스키마 최종 승인
- [ ] `schema_v2_final.sql` 검토 완료
- [ ] 수정 사항 확인 완료
- [ ] 적용 승인

#### Q2. 데이터 변환 우선순위
- [ ] 모든 데이터 한 번에 변환?
- [ ] 단계별 변환 (law → criteria → mediation → counsel)?

#### Q3. 임베딩 생성 환경
- [ ] 로컬 GPU 사용?
- [ ] 원격 GPU (RunPod) 사용?
- [ ] 임베딩 API 서버 주소 확인

---

## 📚 관련 문서

- [데이터 변환 및 스키마 계획서](./데이터_변환_및_스키마_계획.md) - 상세 계획
- [임베딩 기준 및 프로세스](./임베딩_기준_및_프로세스.md) - 임베딩 가이드
- [청킹 및 임베딩 결과 확인 가이드](./청킹%20및%20임베딩%20결과%20확인%20가이드.md) - 검증 가이드
- `backend/database/schema_v2_final.sql` - 최종 스키마
- `backend/scripts/visualize_transformation.py` - 시각화 스크립트

---

## ✅ 체크리스트

### 스키마
- [x] CHECK 제약 조건 수정
- [x] doc_type 확장
- [x] drop 컬럼 추가
- [x] 복합 인덱스 추가
- [x] search_similar_chunks 함수 개선
- [ ] 스키마 적용 및 테스트

### 데이터 변환
- [ ] 법령 변환 로직
- [ ] 기준 변환 로직
- [ ] 분쟁조정사례 변환 로직
- [ ] 피해구제사례 변환 로직
- [ ] 변환 실행
- [ ] 시각화로 검증

### 임베딩
- [ ] 임베딩 API 서버 실행
- [ ] 배치 임베딩 생성
- [ ] 임베딩 품질 검증

### 검색
- [ ] 도메인 파악 함수
- [ ] 기관 확정 함수
- [ ] 유사 사례 검색 함수
- [ ] 검색 테스트

---

**작성자**: Manus AI  
**최종 수정**: 2026-01-06

**상태**: ✅ 요구사항 명확화 완료, Phase 1 (스키마) 완료, Phase 2 (데이터 변환) 대기 중
