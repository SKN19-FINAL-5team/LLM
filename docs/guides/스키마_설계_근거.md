# í†µí•© ìŠ¤í‚¤ë§ˆ vs ë¶„ë¦¬ëœ Vector DB ë¹„êµ ë¶„ì„

**ì‘ì„±ì¼**: 2026-01-06  
**ëŒ€ìƒ**: RAG ë° MAS ì‹œìŠ¤í…œ ì„¤ê³„ì  
**ëª©ì **: `schema_v2_final.sql` í†µí•© ìŠ¤í‚¤ë§ˆ ë°©ì‹ì˜ ì„¤ê³„ ê·¼ê±° ë° ì¥ì  ë¶„ì„

---

## ëª©ì°¨

0. [í†µí•© ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ì˜ ì´í•´ (ì‹ ì… í•„ë…)](#0-í†µí•©-ìŠ¤í‚¤ë§ˆ-êµ¬ì¡°ì˜-ì´í•´-ì‹ ì…-í•„ë…)
1. [ë°ì´í„° êµ¬ì¡° ê°œìš”](#1-ë°ì´í„°-êµ¬ì¡°-ê°œìš”)
2. [Cross-Reference ê²€ìƒ‰: ê·¼ê±° ì¶”ì ì˜ í•µì‹¬](#2-cross-reference-ê²€ìƒ‰-ê·¼ê±°-ì¶”ì ì˜-í•µì‹¬)
3. [Hybrid Filtering: ë‹¤ì°¨ì› í•„í„°ë§](#3-hybrid-filtering-ë‹¤ì°¨ì›-í•„í„°ë§)
4. [Context Window Expansion: ê·¼ê±° ë¬¸ë§¥ í™•ì¥](#4-context-window-expansion-ê·¼ê±°-ë¬¸ë§¥-í™•ì¥)
5. [Multi-Hop Reasoning: ê·¼ê±° ì—°ì‡„ ì¶”ë¡ ](#5-multi-hop-reasoning-ê·¼ê±°-ì—°ì‡„-ì¶”ë¡ )
6. [ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì˜ˆì‹œ](#6-ì‹¤ì œ-ë°ì´í„°-ê¸°ë°˜-ì˜ˆì‹œ)
7. [RAG Performance ë¹„êµ](#7-rag-performance-ë¹„êµ)
8. [ë°ì´í„° ì¼ê´€ì„±: ë²•ë ¹ ê°œì • ì‹œë‚˜ë¦¬ì˜¤](#8-ë°ì´í„°-ì¼ê´€ì„±-ë²•ë ¹-ê°œì •-ì‹œë‚˜ë¦¬ì˜¤)
9. [ê²°ë¡ ](#9-ê²°ë¡ )

---

## 0. í†µí•© ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ì˜ ì´í•´ (ì‹ ì… í•„ë…)

> **ğŸ¯ í•™ìŠµ ëª©í‘œ**: ì´ ì„¹ì…˜ì„ ì½ê³  ë‚˜ë©´ "ì™œ ë°ì´í„° íƒ€ì…ë³„ë¡œ ë³„ë„ í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ í†µí•© í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ëŠ”ì§€" ì •í™•íˆ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 0.1 í•µì‹¬ ê°œë…: í†µí•© ìŠ¤í‚¤ë§ˆ (Unified Schema)

#### âŒ í”í•œ ì˜¤í•´ (ë¶„ë¦¬ ìŠ¤í‚¤ë§ˆ ë°©ì‹)

```
ê° ë°ì´í„° íƒ€ì…ë³„ë¡œ ë³„ë„ì˜ í…Œì´ë¸”ì´ ìˆë‹¤?

law_documents        criteria_documents      case_documents
law_chunks           criteria_chunks         case_chunks
law_chunk_relations  criteria_chunk_relations case_chunk_relations
```

#### âœ… ì‹¤ì œ êµ¬ì¡° (í†µí•© ìŠ¤í‚¤ë§ˆ ë°©ì‹)

```
ëª¨ë“  ë°ì´í„° íƒ€ì…ì´ í•˜ë‚˜ì˜ í…Œì´ë¸”ì— ì €ì¥ë©ë‹ˆë‹¤!

documents (í†µí•©)      â† ë²•ë ¹, ê¸°ì¤€, ì‚¬ë¡€ ëª¨ë‘ ì—¬ê¸°ì—
chunks (í†µí•©)         â† ëª¨ë“  ì²­í¬ê°€ ì—¬ê¸°ì—
chunk_relations (í†µí•©) â† ëª¨ë“  ê´€ê³„ê°€ ì—¬ê¸°ì—
```
all documents (unified)     â† laws, criteria, cases
chunks (unified)            â† all vector embeddings
chunk_relations (unified)   â† hierarchy & cross-references

[S1-D2] laws dedicated      â† structured law metadata
[S1-D3] criteria dedicated  â† structured criteria metadata

### 0.2 ì„¸ ê°€ì§€ í•µì‹¬ í…Œì´ë¸” + ì „ìš© í…Œì´ë¸” (S1-D2/D3)

#### ğŸ“‹ Table 1: `documents` - ë¬¸ì„œ ë©”íƒ€ë°ì´í„° (í†µí•©)
- ëª¨ë“  ë¬¸ì„œ(ë²•ë ¹, íŒë¡€, ê¸°ì¤€ ë“±)ì˜ ê³µí†µ ë©”íƒ€ë°ì´í„°ë¥¼ ì €ì¥
- `doc_type`: `law`, `criteria_resolution`, `counsel_case` ë“± êµ¬ë¶„

#### ğŸ§© Table 2: `chunks` - ë²¡í„° ì„ë² ë”© (í†µí•©)
- ì‹¤ì œ RAG ê²€ìƒ‰ ëŒ€ìƒì´ ë˜ëŠ” í…ìŠ¤íŠ¸ ì¡°ê°
- `embedding`: KURE-v1 (1024ì°¨ì›) ë²¡í„°

#### ğŸ”— Table 3: `chunk_relations` - ê´€ê³„ ì •ì˜ (í†µí•©)
- ìƒìœ„/í•˜ìœ„ ê´€ê³„ (ì¡°-í•­-í˜¸)
- ì°¸ì¡° ê´€ê³„ (ì´ ë²• ì œ7ì¡°ì— ë”°ë¦„)

#### ğŸ›ï¸ Dedicated Tables (ì •í˜• ë°ì´í„° ì§€ì›)
- **[S1-D2] `law_node`**: ë²•ë ¹ ì¡°/í•­/í˜¸/ëª©ì˜ ì •í™•í•œ ê³„ì¸µ êµ¬ì¡°ì™€ ìˆœì„œ ë³´ì¥
- **[S1-D3] `criteria_units`**: ë¶„ìŸí•´ê²°ê¸°ì¤€ì˜ í’ˆëª© ë¶„ë¥˜(Category/Industry) ë° ê·œì¹™ ì •í˜•í™” ì§€ì›

### 0.3 ë°ì´í„° íë¦„ ì˜ˆì‹œ
í„°

**ì—­í• **: ë¬¸ì„œì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” "ëª…í•¨"

```sql
CREATE TABLE documents (
    doc_id VARCHAR(255) PRIMARY KEY,           -- ë¬¸ì„œ ê³ ìœ  ID
    doc_type VARCHAR(50) NOT NULL,             -- ğŸ”‘ íƒ€ì… êµ¬ë¶„: 'law', 'mediation_case', 'counsel_case', 'criteria_*'
    title TEXT NOT NULL,                       -- ë¬¸ì„œ ì œëª©
    source_org VARCHAR(100),                   -- ì¶œì²˜ ê¸°ê´€: 'KCA', 'ECMC', 'statute' ë“±
    category_path TEXT[],                      -- ì¹´í…Œê³ ë¦¬ ê²½ë¡œ: {'ë†ìˆ˜ì¶•ì‚°ë¬¼', 'ë€ë¥˜'}
    url TEXT,                                  -- ì›ë³¸ URL
    collected_at TIMESTAMP,                    -- ìˆ˜ì§‘ ì¼ì‹œ
    metadata JSONB,                            -- ìœ ì—°í•œ ë©”íƒ€ë°ì´í„° (referenced_laws, case_number ë“±)
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**ğŸ’¡ "ìœ ì—°í•œ ë©”íƒ€ë°ì´í„°"ë€?**

`metadata JSONB`ëŠ” **ë¬¸ì„œ íƒ€ì…ë§ˆë‹¤ ë‹¤ë¥¸ ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ìœ ì—°í•œ í•„ë“œ**ì…ë‹ˆë‹¤.

#### âŒ ê³ ì •ëœ ì»¬ëŸ¼ ë°©ì‹ì˜ ë¬¸ì œì 

ë§Œì•½ ê³ ì •ëœ ì»¬ëŸ¼ì„ ì‚¬ìš©í•œë‹¤ë©´:

```sql
-- âŒ ë¬¸ì œ: ê° ë¬¸ì„œ íƒ€ì…ë§ˆë‹¤ í•„ìš”í•œ ì •ë³´ê°€ ë‹¤ë¦„
CREATE TABLE documents (
    doc_id VARCHAR(255) PRIMARY KEY,
    doc_type VARCHAR(50) NOT NULL,
    title TEXT NOT NULL,
    -- ë²•ë ¹ì—ë§Œ í•„ìš”í•œ ì •ë³´
    law_number VARCHAR(50),           -- ë²•ë ¹ë§Œ ì‚¬ìš©
    enforcement_date DATE,             -- ë²•ë ¹ë§Œ ì‚¬ìš©
    -- ì‚¬ë¡€ì—ë§Œ í•„ìš”í•œ ì •ë³´
    case_number VARCHAR(50),           -- ì‚¬ë¡€ë§Œ ì‚¬ìš©
    decision_date DATE,                -- ì‚¬ë¡€ë§Œ ì‚¬ìš©
    -- ê¸°ì¤€ì—ë§Œ í•„ìš”í•œ ì •ë³´
    table_name VARCHAR(50),             -- ê¸°ì¤€ë§Œ ì‚¬ìš©
    part VARCHAR(100),                  -- ê¸°ì¤€ë§Œ ì‚¬ìš©
    -- ... ê³„ì† ì¶”ê°€í•´ì•¼ í•¨
);
```

**ë¬¸ì œì **:
- ë²•ë ¹ ë¬¸ì„œë¥¼ ì €ì¥í•  ë•Œ: `case_number`, `table_name` ë“±ì€ NULLì´ ë¨ (ê³µê°„ ë‚­ë¹„)
- ìƒˆë¡œìš´ ë¬¸ì„œ íƒ€ì… ì¶”ê°€ ì‹œ: í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ í•„ìš” (ALTER TABLE)
- ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€

#### âœ… JSONB ë°©ì‹ì˜ ì¥ì 

```sql
-- âœ… í•´ê²°: í•˜ë‚˜ì˜ JSONB í•„ë“œë¡œ ëª¨ë“  íƒ€ì…ì˜ ì •ë³´ ì €ì¥
CREATE TABLE documents (
    doc_id VARCHAR(255) PRIMARY KEY,
    doc_type VARCHAR(50) NOT NULL,
    title TEXT NOT NULL,
    metadata JSONB  -- ëª¨ë“  íƒ€ì…ì˜ ì •ë³´ë¥¼ ì—¬ê¸°ì— ì €ì¥
);
```

**ì¥ì **:
1. **ë¬¸ì„œ íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ êµ¬ì¡° ê°€ëŠ¥**
   - ë²•ë ¹: `{"law_number": "...", "enforcement_date": "..."}`
   - ì‚¬ë¡€: `{"case_number": "...", "decision_date": "...", "referenced_laws": [...]}`
   - ê¸°ì¤€: `{"table_name": "...", "part": "..."}`

2. **ìƒˆë¡œìš´ í•„ë“œ ì¶”ê°€ê°€ ì‰¬ì›€**
   - í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ ì—†ì´ JSONì— í•„ë“œë§Œ ì¶”ê°€

3. **PostgreSQL JSONBì˜ ê°•ë ¥í•œ ê¸°ëŠ¥**
   - ì¸ë±ì‹± ê°€ëŠ¥ (GIN ì¸ë±ìŠ¤)
   - ì¿¼ë¦¬ ê°€ëŠ¥ (`@>`, `->`, `->>` ì—°ì‚°ì)
   - íš¨ìœ¨ì ì¸ ì €ì¥ ë° ê²€ìƒ‰

#### ğŸ“Š ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

**ì˜ˆì‹œ ë°ì´í„°**:

```sql
-- ì˜ˆì‹œ 1: ë²•ë ¹ ë¬¸ì„œ
INSERT INTO documents VALUES (
    '001589',                                  -- doc_id
    'law',                                     -- doc_type
    'ì†Œë¹„ìê¸°ë³¸ë²•',                             -- title
    'statute',                                 -- source_org
    ARRAY['ì†Œë¹„ì', 'ê¸°ë³¸ë²•'],                  -- category_path
    'https://www.law.go.kr/ë²•ë ¹/ì†Œë¹„ìê¸°ë³¸ë²•',  -- url
    '2026-01-01 00:00:00',                     -- collected_at
    '{"law_number": "ì œ19357í˜¸", "enforcement_date": "2024-01-01"}'::jsonb, -- metadata
    NOW(),
    NOW()
);

-- ì˜ˆì‹œ 2: ë¶„ìŸì¡°ì •ì‚¬ë¡€ ë¬¸ì„œ
INSERT INTO documents VALUES (
    'kca_2015_case_27',                        -- doc_id
    'mediation_case',                          -- doc_type
    'ì˜¨ë¼ì¸ ì‹ ì„ ì‹í’ˆ ë¶€íŒ¨ í™˜ë¶ˆ ìš”êµ¬',           -- title
    'KCA',                                     -- source_org
    ARRAY['ìƒí’ˆ(ì¬í™”)', 'ë†ìˆ˜ì¶•ì‚°ë¬¼', 'ë€ë¥˜'],  -- category_path
    'https://www.kca.go.kr/case/2015/27',      -- url
    '2025-12-01 10:30:00',                     -- collected_at
    '{"case_number": "2015ì¼ê°€27", "decision_date": "2015-03-15", "referenced_laws": ["001589|A10", "000422|A23"]}'::jsonb,
    NOW(),
    NOW()
);

-- ì˜ˆì‹œ 3: ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€ ë¬¸ì„œ
INSERT INTO documents VALUES (
    'table2_agricultural',                     -- doc_id
    'criteria_resolution',                     -- doc_type
    'ë†ìˆ˜ì¶•ì‚°ë¬¼ ë¶„ìŸí•´ê²°ê¸°ì¤€',                  -- title
    'KCA',                                     -- source_org
    ARRAY['ìƒí’ˆ(ì¬í™”)', 'ë†ìˆ˜ì¶•ì‚°ë¬¼'],          -- category_path
    'https://www.kca.go.kr/criteria/table2',   -- url
    '2026-01-01 00:00:00',                     -- collected_at
    '{"table_name": "table2", "part": "ë†ìˆ˜ì¶•ì‚°ë¬¼"}'::jsonb,
    NOW(),
    NOW()
);
```

#### ğŸ” JSONB ì¿¼ë¦¬ ì˜ˆì‹œ

PostgreSQLì˜ JSONBëŠ” ê°•ë ¥í•œ ì¿¼ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤:

```sql
-- ì˜ˆì‹œ 1: íŠ¹ì • ë²•ë ¹ì„ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ì‚¬ë¡€ ì°¾ê¸°
SELECT doc_id, title, metadata->>'case_number' AS case_number
FROM documents
WHERE doc_type = 'mediation_case'
  AND metadata @> '{"referenced_laws": ["001589|A10"]}'::jsonb;
-- @> ì—°ì‚°ì: JSONBê°€ íŠ¹ì • í‚¤-ê°’ì„ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸

-- ì˜ˆì‹œ 2: íŠ¹ì • ì‚¬ê±´ë²ˆí˜¸ë¡œ ê²€ìƒ‰
SELECT doc_id, title, metadata->>'decision_date' AS decision_date
FROM documents
WHERE metadata->>'case_number' = '2015ì¼ê°€27';
-- -> ì—°ì‚°ì: JSONBì—ì„œ í‚¤ë¡œ ê°’ ì¶”ì¶œ (JSONB íƒ€ì… ë°˜í™˜)
-- ->> ì—°ì‚°ì: JSONBì—ì„œ í‚¤ë¡œ ê°’ ì¶”ì¶œ (TEXT íƒ€ì… ë°˜í™˜)

-- ì˜ˆì‹œ 3: referenced_laws ë°°ì—´ì—ì„œ íŠ¹ì • ë²•ë ¹ í¬í•¨ ì—¬ë¶€ í™•ì¸
SELECT doc_id, title, metadata->'referenced_laws' AS laws
FROM documents
WHERE metadata->'referenced_laws' @> '["001589|A10"]'::jsonb;
-- ë°°ì—´ì—ì„œ íŠ¹ì • ê°’ í¬í•¨ ì—¬ë¶€ í™•ì¸

-- ì˜ˆì‹œ 4: ë²•ë ¹ë²ˆí˜¸ë¡œ ê²€ìƒ‰
SELECT doc_id, title, metadata->>'law_number' AS law_number
FROM documents
WHERE doc_type = 'law'
  AND metadata->>'law_number' LIKE '%19357%';
```

**JSONB ì—°ì‚°ì ìš”ì•½**:

| ì—°ì‚°ì | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `->` | í‚¤ë¡œ ê°’ ì¶”ì¶œ (JSONB ë°˜í™˜) | `metadata->'case_number'` |
| `->>` | í‚¤ë¡œ ê°’ ì¶”ì¶œ (TEXT ë°˜í™˜) | `metadata->>'case_number'` |
| `@>` | í¬í•¨ ì—¬ë¶€ í™•ì¸ | `metadata @> '{"case_number": "2015ì¼ê°€27"}'` |
| `?` | í‚¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ | `metadata ? 'referenced_laws'` |
| `?\|` | í‚¤ ì¤‘ í•˜ë‚˜ ì¡´ì¬ ì—¬ë¶€ | `metadata ?\| array['case_number', 'law_number']` |

**ğŸ’¡ í•µì‹¬ ì •ë¦¬**:

1. **"ìœ ì—°í•œ"** = ë¬¸ì„œ íƒ€ì…ë§ˆë‹¤ ë‹¤ë¥¸ êµ¬ì¡°ì˜ ë°ì´í„°ë¥¼ ì €ì¥ ê°€ëŠ¥
2. **"ë©”íƒ€ë°ì´í„°"** = ë¬¸ì„œì˜ ë¶€ê°€ ì •ë³´ (ë²•ë ¹ë²ˆí˜¸, ì‚¬ê±´ë²ˆí˜¸, ì°¸ì¡° ë²•ë ¹ ë“±)
3. **JSONB** = PostgreSQLì˜ JSON íƒ€ì… (ì¸ë±ì‹± ë° ì¿¼ë¦¬ ìµœì í™”)

---

#### ğŸ“¦ Table 2: `chunks` - ì²­í¬ ë° ì„ë² ë”©

**ì—­í• **: ë¬¸ì„œë¥¼ ê²€ìƒ‰ ê°€ëŠ¥í•œ ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ê³ , ë²¡í„° ì„ë² ë”© ì €ì¥

```sql
CREATE TABLE chunks (
    chunk_id VARCHAR(255) PRIMARY KEY,         -- ì²­í¬ ê³ ìœ  ID
    doc_id VARCHAR(255) NOT NULL               -- ğŸ”— ì™¸ë˜í‚¤: ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€
        REFERENCES documents(doc_id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,              -- ì²­í¬ ìˆœì„œ (0-based)
    chunk_total INTEGER NOT NULL,              -- í•´ë‹¹ ë¬¸ì„œì˜ ì´ ì²­í¬ ìˆ˜
    chunk_type VARCHAR(50),                    -- ğŸ”‘ ì²­í¬ íƒ€ì…: 'article', 'resolution_row', 'decision' ë“±
    content TEXT NOT NULL,                     -- ì²­í¬ ë‚´ìš© (ì‹¤ì œ í…ìŠ¤íŠ¸)
    content_length INTEGER,                    -- ë‚´ìš© ê¸¸ì´
    embedding vector(1024),                    -- ğŸ§  ë²¡í„° ì„ë² ë”© (KURE-v1, 1024ì°¨ì›)
    embedding_model VARCHAR(50) DEFAULT 'KURE-v1',
    drop BOOLEAN DEFAULT FALSE,                -- ì‚­ì œ í”Œë˜ê·¸ (ê²€ìƒ‰ ì œì™¸)
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(doc_id, chunk_index),               -- ë™ì¼ ë¬¸ì„œ ë‚´ ì¤‘ë³µ ì¸ë±ìŠ¤ ë°©ì§€
    CHECK (chunk_index >= 0),                  -- 0-based indexing
    CHECK (chunk_total > 0),
    CHECK (chunk_index < chunk_total)
);
```

**ì˜ˆì‹œ ë°ì´í„°**:

```sql
-- ì˜ˆì‹œ 1: ë²•ë ¹ ì¡°ë¬¸ ì²­í¬
INSERT INTO chunks VALUES (
    '001589_A10_P1',                           -- chunk_id
    '001589',                                  -- doc_id (ì†Œë¹„ìê¸°ë³¸ë²•)
    9,                                         -- chunk_index (10ë²ˆì§¸ ì²­í¬)
    50,                                        -- chunk_total (ì´ 50ê°œ ì²­í¬)
    'paragraph',                               -- chunk_type (í•­)
    'ì œ10ì¡°(ì†Œë¹„ìì˜ ê¸°ë³¸ì  ê¶Œë¦¬) â‘  ì†Œë¹„ìëŠ” ë¬¼í’ˆ ë˜ëŠ” ìš©ì—­(ì´í•˜ "ë¬¼í’ˆë“±"ì´ë¼ í•œë‹¤)ì„ ì‚¬ìš©í•¨ì— ìˆì–´ì„œ ìƒëª…Â·ì‹ ì²´ ë˜ëŠ” ì¬ì‚°ì— ëŒ€í•œ ìœ„í•´ë¡œë¶€í„° ë³´í˜¸ë°›ì„ ê¶Œë¦¬ë¥¼ ê°€ì§„ë‹¤.',
    120,                                       -- content_length
    '[0.123, -0.456, 0.789, ...]'::vector(1024), -- embedding (ì‹¤ì œë¡œëŠ” 1024ì°¨ì›)
    'KURE-v1',
    FALSE,
    NOW(),
    NOW()
);

-- ì˜ˆì‹œ 2: ë¶„ìŸì¡°ì •ì‚¬ë¡€ ê²°ì •ë¬¸ ì²­í¬
INSERT INTO chunks VALUES (
    'kca_2015_case_27_decision',               -- chunk_id
    'kca_2015_case_27',                        -- doc_id (ë¶„ìŸì¡°ì •ì‚¬ë¡€)
    2,                                         -- chunk_index (3ë²ˆì§¸ ì²­í¬)
    5,                                         -- chunk_total (ì´ 5ê°œ ì²­í¬)
    'decision',                                -- chunk_type (ê²°ì •ë¬¸)
    'ã€ê²°ì •ã€‘ ì‹ ì²­ì¸ì´ êµ¬ì…í•œ ë€ë¥˜(ê³„ë€)ê°€ ë¶€íŒ¨í•˜ì—¬ ë°˜í’ˆì„ ìš”êµ¬í•˜ì˜€ìœ¼ë‚˜ í”¼ì‹ ì²­ì¸ì´ ê±°ë¶€í•œ ì‚¬ì•ˆì—ì„œ, ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€ì— ë”°ë¼ êµ¬ì…ê°€ í™˜ê¸‰ì„ ëª…í•¨. ê·¼ê±°: ì¢…ìì‚°ì—…ë²• ì œ23ì¡°, ì†Œë¹„ìê¸°ë³¸ë²• ì œ10ì¡°.',
    150,                                       -- content_length
    '[0.234, -0.567, 0.890, ...]'::vector(1024),
    'KURE-v1',
    FALSE,
    NOW(),
    NOW()
);

-- ì˜ˆì‹œ 3: ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€ ì²­í¬
INSERT INTO chunks VALUES (
    'table2_row_egg_spoilage',                 -- chunk_id
    'table2_agricultural',                     -- doc_id (ë†ìˆ˜ì¶•ì‚°ë¬¼ ê¸°ì¤€)
    0,                                         -- chunk_index (ì²« ë²ˆì§¸ ì²­í¬)
    1,                                         -- chunk_total (ì´ 1ê°œ ì²­í¬)
    'resolution_row',                          -- chunk_type (í•´ê²°ê¸°ì¤€ í–‰)
    'ã€í’ˆëª©ã€‘ 1ë€ë¥˜, 2ìœ¡ë¥˜, 3ê³¡ë¥˜, 4ê³¼ì¼, 5ì•¼ì±„ë¥˜, 6ìˆ˜ì‚°ë¬¼ë¥˜\nã€ë¶„ìŸìœ í˜•ã€‘ ë¶€íŒ¨, ë³€ì§ˆ\nã€í•´ê²°ê¸°ì¤€ã€‘ o ë‹¹í•´í’ˆëª© êµí™˜ ë˜ëŠ” êµ¬ì…ê°€ í™˜ê¸‰\nã€ê´€ë ¨ë²•ë ¹ã€‘ ì¢…ìì‚°ì—…ë²• ì œ23ì¡°',
    200,                                       -- content_length
    '[0.345, -0.678, 0.901, ...]'::vector(1024),
    'KURE-v1',
    FALSE,
    NOW(),
    NOW()
);
```

---

#### ğŸ”— Table 3: `chunk_relations` - ì²­í¬ ê°„ ê´€ê³„

**ì—­í• **: ì²­í¬ ê°„ì˜ ìˆœì°¨, ì¸ìš©, ì—°ê´€ ê´€ê³„ ê´€ë¦¬

**âš ï¸ ì¤‘ìš”**: ì´ í…Œì´ë¸”ì€ **"ì²­í¬ê°€ ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€"ë¥¼ ì•Œë ¤ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤!**  
ê·¸ê²ƒì€ `chunks.doc_id` ì™¸ë˜í‚¤ê°€ ë‹´ë‹¹í•©ë‹ˆë‹¤.

```sql
CREATE TABLE chunk_relations (
    source_chunk_id VARCHAR(255) NOT NULL      -- ê´€ê³„ì˜ ì¶œë°œ ì²­í¬
        REFERENCES chunks(chunk_id) ON DELETE CASCADE,
    target_chunk_id VARCHAR(255) NOT NULL      -- ê´€ê³„ì˜ ë„ì°© ì²­í¬
        REFERENCES chunks(chunk_id) ON DELETE CASCADE,
    relation_type VARCHAR(50) NOT NULL,        -- ğŸ”‘ ê´€ê³„ íƒ€ì…:
                                               --   'next': ë‹¤ìŒ ì²­í¬ (ìˆœì°¨)
                                               --   'prev': ì´ì „ ì²­í¬ (ì—­ìˆœ)
                                               --   'cited': ì¸ìš© ê´€ê³„ (Aê°€ Bë¥¼ ì¸ìš©)
                                               --   'related': ì—°ê´€ ê´€ê³„ (ìœ ì‚¬ ì£¼ì œ)
    confidence FLOAT DEFAULT 1.0,              -- ê´€ê³„ ì‹ ë¢°ë„ (0.0~1.0)
                                               -- âš ï¸ ì£¼ì˜: í˜„ì¬ ëŒ€ë¶€ë¶„ì˜ ê´€ê³„ëŠ” í™•ì‹¤í•˜ë¯€ë¡œ 1.0
                                               -- 'related' íƒ€ì…ì—ì„œë§Œ ì˜ë¯¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (source_chunk_id, target_chunk_id, relation_type),
    CHECK (confidence >= 0.0 AND confidence <= 1.0)
);
```

**ì˜ˆì‹œ ë°ì´í„°**:

```sql
-- ì˜ˆì‹œ 1: ë²•ë ¹ ì¡°ë¬¸ ìˆœì°¨ ê´€ê³„ (ê°™ì€ ë¬¸ì„œ ë‚´)
-- ì œ10ì¡° ì œ1í•­ â†’ ì œ10ì¡° ì œ2í•­ (next)
INSERT INTO chunk_relations VALUES (
    '001589_A10_P1',                           -- source (ì œ10ì¡° ì œ1í•­)
    '001589_A10_P2',                           -- target (ì œ10ì¡° ì œ2í•­)
    'next',                                    -- relation_type (ë‹¤ìŒ í•­)
    1.0,                                       -- confidence
    NOW()
);

-- ì œ750ì¡° ì œ10í•­ â†’ ì œ750ì¡° ì œ9í•­ (prev, ì—­ìˆœ)
INSERT INTO chunk_relations VALUES (
    '001589_A750_P10',                         -- source (ì œ750ì¡° ì œ10í•­)
    '001589_A750_P9',                          -- target (ì œ750ì¡° ì œ9í•­)
    'prev',                                    -- relation_type (ì´ì „ í•­)
    1.0,
    NOW()
);

-- ì˜ˆì‹œ 2: ë¶„ìŸì¡°ì •ì‚¬ë¡€ê°€ ë²•ë ¹ì„ ì¸ìš© (ë‹¤ë¥¸ ë¬¸ì„œ ê°„)
-- âš ï¸ ì£¼ì˜: ëª…ì‹œì ìœ¼ë¡œ ì¸ìš©ëœ ê²½ìš°ëŠ” í™•ì‹¤í•˜ë¯€ë¡œ confidence = 1.0ì´ ë§ìŠµë‹ˆë‹¤
INSERT INTO chunk_relations VALUES (
    'kca_2015_case_27_decision',               -- source (ì‚¬ë¡€ ê²°ì •ë¬¸)
    '001589_A10_P1',                           -- target (ì†Œë¹„ìê¸°ë³¸ë²• ì œ10ì¡° ì œ1í•­)
    'cited',                                   -- relation_type (ì¸ìš©)
    1.0,                                       -- confidence (ëª…ì‹œì  ì¸ìš©ì´ë¯€ë¡œ í™•ì‹¤í•¨)
    NOW()
);

-- ì˜ˆì‹œ 3: ì‚¬ë¡€ê°€ ê¸°ì¤€ì„ ì ìš© (ë‹¤ë¥¸ ë¬¸ì„œ ê°„)
INSERT INTO chunk_relations VALUES (
    'kca_2015_case_27_decision',               -- source (ì‚¬ë¡€ ê²°ì •ë¬¸)
    'table2_row_egg_spoilage',                 -- target (ë¶„ìŸí•´ê²°ê¸°ì¤€)
    'cited',                                   -- relation_type (ê¸°ì¤€ ì ìš©)
    1.0,                                       -- confidence (ëª…ì‹œì  ì ìš©ì´ë¯€ë¡œ í™•ì‹¤í•¨)
    NOW()
);

-- ì˜ˆì‹œ 4: ìœ ì‚¬í•œ ì‚¬ë¡€ ê°„ ì—°ê´€ ê´€ê³„ (ë‹¤ë¥¸ ë¬¸ì„œ ê°„)
-- âš ï¸ ì£¼ì˜: ì´ ê´€ê³„ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
--          ë§Œì•½ ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•œë‹¤ë©´ confidenceëŠ” ë‚®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
--          í•˜ì§€ë§Œ í˜„ì¬ëŠ” ì´ íƒ€ì…ì˜ ê´€ê³„ë¥¼ ìƒì„±í•˜ëŠ” ë¡œì§ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
INSERT INTO chunk_relations VALUES (
    'kca_2015_case_27_decision',               -- source (ë€ë¥˜ ë¶€íŒ¨ ì‚¬ë¡€)
    'ecmc_2016_case_123_decision',             -- target (ì‹ ì„ ì‹í’ˆ ë¶€íŒ¨ ì‚¬ë¡€)
    'related',                                 -- relation_type (ìœ ì‚¬ ì‚¬ë¡€)
    0.75,                                      -- confidence (ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜, ì˜ˆì‹œê°’)
    NOW()
);
```

**ğŸ’¡ ì¤‘ìš” í¬ì¸íŠ¸**:

1. **"ëª¨ë“  ì²­í¬ ê°„ì˜ ê´€ê³„"ë¥¼ ë‹´ê³  ìˆë‹¤** âœ…
   - ë§ìŠµë‹ˆë‹¤! `chunk_relations`ëŠ” ì²­í¬ ê°„ì˜ ëª¨ë“  ê´€ê³„ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

2. **ê°™ì€ ë¬¸ì„œ ë‚´ ìˆœì°¨ ê´€ê³„**
   - ê°™ì€ ë¬¸ì„œ ë‚´ì—ì„œ `chunk_index`ë¡œ ìˆœì„œë¥¼ ì•Œ ìˆ˜ ìˆì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ `chunk_relations`ì— ì €ì¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
   - ì˜ˆ: `001589_A10_P1` â†’ `001589_A10_P2` (next)
   - ì˜ˆ: `001589_A750_P10` â†’ `001589_A750_P9` (prev)

3. **ë‹¤ë¥¸ ë¬¸ì„œ ê°„ ê´€ê³„ (ë°˜ë“œì‹œ í•„ìš”)**
   - ë‹¤ë¥¸ ë¬¸ì„œì— ì†í•œ ì²­í¬ ê°„ì˜ ê´€ê³„ëŠ” **ë°˜ë“œì‹œ** `chunk_relations`ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
   - ì˜ˆ: ì‚¬ë¡€ â†’ ë²•ë ¹ (cited)
   - ì˜ˆ: ì‚¬ë¡€ â†’ ê¸°ì¤€ (cited)
   - ì˜ˆ: ì‚¬ë¡€ â†’ ì‚¬ë¡€ (related)

4. **ê´€ê³„ íƒ€ì…**
   - `next`: ë‹¤ìŒ ì²­í¬ (ìˆœì°¨) - confidence: 1.0 (í™•ì‹¤í•œ ìˆœì°¨ ê´€ê³„)
   - `prev`: ì´ì „ ì²­í¬ (ì—­ìˆœ) - confidence: 1.0 (í™•ì‹¤í•œ ìˆœì°¨ ê´€ê³„)
   - `cited`: ì¸ìš© ê´€ê³„ (Aê°€ Bë¥¼ ì¸ìš©) - confidence: 1.0 (ëª…ì‹œì  ì¸ìš©)
   - `related`: ì—°ê´€ ê´€ê³„ (ìœ ì‚¬ ì£¼ì œ) - confidence: 0.0~1.0 (ìœ ì‚¬ë„ ê¸°ë°˜, í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)

#### âš ï¸ `confidence` í•„ë“œì— ëŒ€í•œ ì¤‘ìš”í•œ ì§ˆë¬¸

**Q: `confidence` í•„ë“œê°€ í•„ìˆ˜ì ì¸ê°€ìš”?**

**A: ì•„ë‹ˆìš”, í•„ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤!**

1. **ê¸°ìˆ ì ìœ¼ë¡œ**: `DEFAULT 1.0`ì´ë¯€ë¡œ ê°’ì„ ì§€ì •í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
2. **ì‹¤ì œ ì‚¬ìš©**: 
   - `next`, `prev`, `cited` íƒ€ì…: ëª¨ë‘ í™•ì‹¤í•œ ê´€ê³„ì´ë¯€ë¡œ `1.0`ì´ ë§ìŠµë‹ˆë‹¤.
   - `related` íƒ€ì…: ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ì´ë¼ë©´ ë‚®ì„ ìˆ˜ ìˆì§€ë§Œ, **í˜„ì¬ ì´ íƒ€ì…ì˜ ê´€ê³„ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë¡œì§ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

3. **ë¯¸ë˜ í™•ì¥ì„±**:
   - Graph RAG êµ¬í˜„ ì‹œ `related` íƒ€ì… ê´€ê³„ë¥¼ ìë™ ìƒì„±í•  ë•Œ ìœ ì‚¬ë„ ê¸°ë°˜ confidenceê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - í˜„ì¬ëŠ” ë¯¸ë˜ í™•ì¥ì„±ì„ ìœ„í•œ í•„ë“œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê²°ë¡ **: 
- âœ… í˜„ì¬ ëŒ€ë¶€ë¶„ì˜ ê´€ê³„ëŠ” í™•ì‹¤í•˜ë¯€ë¡œ `confidence = 1.0`ì´ ë§ìŠµë‹ˆë‹¤.
- âš ï¸ `related` íƒ€ì…ì—ì„œë§Œ ì˜ë¯¸ê°€ ìˆì„ ìˆ˜ ìˆì§€ë§Œ, í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ğŸ’¡ **í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, ë¯¸ë˜ í™•ì¥ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.**

#### ğŸ¤” Graph RAGë¥¼ ì•ˆ ì“°ë©´ `confidence` í•„ë“œê°€ í•„ìš” ì—†ëŠ”ê°€ìš”?

**A: ë„¤, ë§ìŠµë‹ˆë‹¤! Graph RAGë¥¼ ì•ˆ ì“°ë©´ `confidence` í•„ë“œëŠ” ì‚¬ì‹¤ìƒ í•„ìš” ì—†ìŠµë‹ˆë‹¤.**

**ì´ìœ **:

1. **í˜„ì¬ ì‚¬ìš©ë˜ëŠ” ê´€ê³„ íƒ€ì…**:
   - `next`, `prev`: ê°™ì€ ë¬¸ì„œ ë‚´ ìˆœì°¨ ê´€ê³„ â†’ í•­ìƒ í™•ì‹¤í•˜ë¯€ë¡œ `confidence = 1.0`
   - `cited`: ëª…ì‹œì ìœ¼ë¡œ ì¸ìš©ëœ ê´€ê³„ â†’ í•­ìƒ í™•ì‹¤í•˜ë¯€ë¡œ `confidence = 1.0`
   - **â†’ ëª¨ë“  ê´€ê³„ê°€ í™•ì‹¤í•˜ë¯€ë¡œ confidence ê°’ì´ ì˜ë¯¸ ì—†ìŒ**

2. **Graph RAGì—ì„œë§Œ ì˜ë¯¸ê°€ ìˆëŠ” ê²½ìš°**:
   - `related` íƒ€ì…: ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë˜ëŠ” ê´€ê³„
   - ì´ ê²½ìš° ìœ ì‚¬ë„ì— ë”°ë¼ `confidence = 0.6~0.9` ê°™ì€ ê°’ì´ í•„ìš”
   - **í•˜ì§€ë§Œ Graph RAGë¥¼ ì•ˆ ì“°ë©´ `related` íƒ€ì… ê´€ê³„ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ**

3. **ì‹¤ì œ í˜„í™©**:
   - í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ Graph RAGëŠ” **Phase 3 (ì¥ê¸° ê³„íš)**ì— ìˆìœ¼ë©° ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ
   - `chunk_relations` í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ INSERTí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŒ
   - í‰ê°€ ë³´ê³ ì„œ: "í˜„ì¬ ë¯¸ì‚¬ìš©: ë°ì´í„° 0ê±´"

**ìµœì¢… ë‹µë³€**:

| ì‹œë‚˜ë¦¬ì˜¤ | `confidence` í•„ë“œ í•„ìš” ì—¬ë¶€ |
|---------|------------------------|
| **Graph RAG ì‚¬ìš© ì•ˆ í•¨** | âŒ **í•„ìš” ì—†ìŒ** (ëª¨ë“  ê´€ê³„ê°€ í™•ì‹¤í•˜ë¯€ë¡œ í•­ìƒ 1.0) |
| **Graph RAG ì‚¬ìš©** | âœ… **í•„ìš”í•¨** (`related` íƒ€ì…ì—ì„œ ìœ ì‚¬ë„ ê¸°ë°˜ confidence í•„ìš”) |

**ê¶Œì¥ì‚¬í•­**:
- Graph RAGë¥¼ í™•ì‹¤íˆ ì•ˆ ì“¸ ì˜ˆì •ì´ë¼ë©´: `confidence` í•„ë“œë¥¼ ì œê±°í•´ë„ ë©ë‹ˆë‹¤ (í•˜ì§€ë§Œ DEFAULT 1.0ì´ë¯€ë¡œ í° ë¬¸ì œëŠ” ì—†ìŒ)
- ë¯¸ë˜ì— Graph RAGë¥¼ ë„ì…í•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤ë©´: ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤
- **í˜„ì¬ëŠ”**: `DEFAULT 1.0`ì´ë¯€ë¡œ ê·¸ëƒ¥ ë‘ì–´ë„ ë¬´ë°©í•©ë‹ˆë‹¤ (ê³µê°„ ë‚­ë¹„ë„ ê±°ì˜ ì—†ìŒ)

---

### 0.3 í…Œì´ë¸” ê°„ ê´€ê³„ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
erDiagram
    documents ||--o{ chunks : "1:N (has)"
    chunks ||--o{ chunk_relations : "N:M (relates)"
    
    documents {
        varchar doc_id PK
        varchar doc_type "ë²•ë ¹/ì‚¬ë¡€/ê¸°ì¤€ êµ¬ë¶„"
        text title
        varchar source_org
        text[] category_path
        jsonb metadata
    }
    
    chunks {
        varchar chunk_id PK
        varchar doc_id FK
        int chunk_index "ì²­í¬ ìˆœì„œ"
        varchar chunk_type "ì¡°ë¬¸/ê²°ì •ë¬¸/ê¸°ì¤€ ë“±"
        text content
        vector embedding "1024ì°¨ì› ë²¡í„°"
        bool drop "ê²€ìƒ‰ ì œì™¸ í”Œë˜ê·¸"
    }
    
    chunk_relations {
        varchar source_chunk_id FK
        varchar target_chunk_id FK
        varchar relation_type "next/prev/cited/related"
        float confidence
    }
```

**í•µì‹¬ í¬ì¸íŠ¸**:
1. `documents` â† `chunks`: **1:N ê´€ê³„** (í•˜ë‚˜ì˜ ë¬¸ì„œëŠ” ì—¬ëŸ¬ ì²­í¬ë¥¼ ê°€ì§)
2. `chunks` â†” `chunks`: **N:M ê´€ê³„** (`chunk_relations`ë¥¼ í†µí•´ ì²­í¬ë¼ë¦¬ ì—°ê²°)

---

### 0.4 ì‹¤ì œ ë°ì´í„° íë¦„ ì˜ˆì‹œ

#### ì‹œë‚˜ë¦¬ì˜¤: "ë€ë¥˜ ë¶€íŒ¨ í™˜ë¶ˆ" ì§ˆì˜ ì²˜ë¦¬

```sql
-- Step 1: ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ ê´€ë ¨ ì²­í¬ ì°¾ê¸°
SELECT 
    c.chunk_id,
    c.content,
    c.chunk_type,
    d.doc_type,
    d.title
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE c.embedding <=> '[query_vector]'::vector < 0.3  -- ìœ ì‚¬ë„ 0.7 ì´ìƒ
  AND c.drop = FALSE
ORDER BY c.embedding <=> '[query_vector]'::vector
LIMIT 5;
```

**ê²°ê³¼**:
| chunk_id | content (ìš”ì•½) | chunk_type | doc_type | title |
|----------|---------------|------------|----------|-------|
| table2_row_egg_spoilage | ë€ë¥˜ ë¶€íŒ¨ ì‹œ í™˜ê¸‰ | resolution_row | criteria_resolution | ë†ìˆ˜ì¶•ì‚°ë¬¼ ê¸°ì¤€ |
| kca_2015_case_27_decision | ê³„ë€ ë¶€íŒ¨ í™˜ê¸‰ ê²°ì • | decision | mediation_case | ë€ë¥˜ ë¶€íŒ¨ ì‚¬ë¡€ |
| 001589_A10_P1 | ì†Œë¹„ì ë³´í˜¸ë°›ì„ ê¶Œë¦¬ | paragraph | law | ì†Œë¹„ìê¸°ë³¸ë²• |

```sql
-- Step 2: ê¸°ì¤€ ì²­í¬ê°€ ì¸ìš©í•œ ë²•ë ¹ ì¡°ë¬¸ ì°¾ê¸°
SELECT 
    cr.relation_type,
    c_target.content AS cited_law,
    d_target.title AS law_title
FROM chunk_relations cr
JOIN chunks c_target ON cr.target_chunk_id = c_target.chunk_id
JOIN documents d_target ON c_target.doc_id = d_target.doc_id
WHERE cr.source_chunk_id = 'table2_row_egg_spoilage'
  AND cr.relation_type = 'cited'
  AND d_target.doc_type = 'law';
```

**ê²°ê³¼**:
| relation_type | cited_law (ìš”ì•½) | law_title |
|---------------|-----------------|-----------|
| cited | ì œ23ì¡° (ì¢…ìì˜ í’ˆì§ˆë³´ì¦) | ì¢…ìì‚°ì—…ë²• |

â†’ **ì´ë ‡ê²Œ í•œ ë²ˆì˜ JOIN ì¿¼ë¦¬ë¡œ "ê¸°ì¤€ â†’ ë²•ë ¹" ê·¼ê±° ì²´ì¸ì„ ì¶”ì í•©ë‹ˆë‹¤!**

---

### 0.5 ì™œ í†µí•© ìŠ¤í‚¤ë§ˆì¸ê°€?

#### âŒ ë¶„ë¦¬ ìŠ¤í‚¤ë§ˆì˜ ë¬¸ì œ

```python
# 4ë²ˆì˜ ì„ë² ë”© ê²€ìƒ‰ í•„ìš”
law_results = search_law_db(query)
criteria_results = search_criteria_db(query)
case_results = search_case_db(query)
counsel_results = search_counsel_db(query)

# âŒ ë¬¸ì œì :
# 1. 4ë°°ì˜ ë¹„ìš©
# 2. 4ë°°ì˜ ì§€ì—°ì‹œê°„
# 3. ê²°ê³¼ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³‘í•©í•´ì•¼ í•¨
# 4. ê´€ê³„ë¥¼ ì¶”ì í•  ìˆ˜ ì—†ìŒ
```

#### âœ… í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì¥ì 

```python
# 1ë²ˆì˜ ê²€ìƒ‰ìœ¼ë¡œ ëª¨ë“  íƒ€ì… ê²€ìƒ‰
results = search_similar_chunks(
    query_embedding,
    doc_type_filter=None,  # ëª¨ë“  íƒ€ì… ê²€ìƒ‰
    top_k=10
)

# âœ… ì¥ì :
# 1. 1/4 ë¹„ìš©
# 2. 1/4 ì§€ì—°ì‹œê°„
# 3. ìë™ìœ¼ë¡œ íƒ€ì…ë³„ ì •ë ¬ ê°€ëŠ¥
# 4. JOINìœ¼ë¡œ ê´€ê³„ ì¶”ì  ê°€ëŠ¥
```

---

### 0.6 ì‹ ì… ì‚¬ì› ìê°€ ì§„ë‹¨ í€´ì¦ˆ

#### Q1. ë‹¤ìŒ ì¤‘ ë§ëŠ” ì„¤ëª…ì€?
- [ ] A. ë²•ë ¹ ë°ì´í„°ëŠ” `law_documents` í…Œì´ë¸”ì— ì €ì¥ëœë‹¤
- [x] B. ë²•ë ¹ ë°ì´í„°ëŠ” `documents` í…Œì´ë¸”ì— `doc_type='law'`ë¡œ ì €ì¥ëœë‹¤

#### Q2. ì²­í¬ê°€ ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€ ì•Œë ¤ì£¼ëŠ” ê²ƒì€?
- [x] A. `chunks.doc_id` ì™¸ë˜í‚¤
- [ ] B. `chunk_relations` í…Œì´ë¸”
- [ ] C. `chunks.chunk_type` ì»¬ëŸ¼

#### Q3. `chunk_relations` í…Œì´ë¸”ì˜ ì—­í• ì€?
- [ ] A. ì²­í¬ê°€ ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€ í‘œì‹œ
- [x] B. ì²­í¬ ê°„ì˜ ìˆœì°¨/ì¸ìš©/ì—°ê´€ ê´€ê³„ ê´€ë¦¬
- [ ] C. ì²­í¬ì˜ ì„ë² ë”©ì„ ì €ì¥

#### Q4. ë‹¤ìŒ ì¤‘ í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì¥ì ì´ ì•„ë‹Œ ê²ƒì€?
- [ ] A. ê²€ìƒ‰ ë¹„ìš© 75% ì ˆê°
- [ ] B. í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  íƒ€ì… ê²€ìƒ‰
- [x] C. ê° ë°ì´í„° íƒ€ì…ë³„ë¡œ ë…ë¦½ì  ê´€ë¦¬

**ì •ë‹µ í•´ì„¤**:
- Q1: ëª¨ë“  ë¬¸ì„œëŠ” **í•˜ë‚˜ì˜ `documents` í…Œì´ë¸”**ì— ì €ì¥ë©ë‹ˆë‹¤.
- Q2: `doc_id` ì™¸ë˜í‚¤ê°€ ë¬¸ì„œ-ì²­í¬ ê´€ê³„ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
- Q3: `chunk_relations`ëŠ” ì²­í¬ë¼ë¦¬ì˜ ê´€ê³„ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
- Q4: í†µí•© ìŠ¤í‚¤ë§ˆëŠ” **í†µí•© ê´€ë¦¬**ê°€ í•µì‹¬ì´ë¯€ë¡œ CëŠ” ì¥ì ì´ ì•„ë‹™ë‹ˆë‹¤.

---

## 1. ë°ì´í„° êµ¬ì¡° ê°œìš”

### 1.1 í˜„ì¬ ë³´ìœ  ë°ì´í„°

```
backend/data/
â”œâ”€â”€ law/                    # ë²•ë ¹ (11ê°œ)
â”‚   â”œâ”€â”€ Consumer_Basic_Law_chunks.jsonl
â”‚   â”œâ”€â”€ E-Commerce_Consumer_Law_chunks.jsonl
â”‚   â””â”€â”€ ...
â”œâ”€â”€ criteria/               # ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€ (6ê°œ)
â”‚   â”œâ”€â”€ table2_resolution_row_chunks.jsonl
â”‚   â”œâ”€â”€ table1_item_chunks.jsonl
â”‚   â””â”€â”€ ...
â”œâ”€â”€ dispute_resolution/     # ë¶„ìŸì¡°ì •ì‚¬ë¡€ (4ê°œ)
â”‚   â”œâ”€â”€ kca_final.jsonl
â”‚   â”œâ”€â”€ ecmc_final_rag_chunks_normalized.jsonl
â”‚   â””â”€â”€ ...
â””â”€â”€ compensation_case/      # í”¼í•´êµ¬ì œ ë° ìƒë‹´ì‚¬ë¡€ (3ê°œ)
    â”œâ”€â”€ cs_116_chunks_v2.jsonl
    â””â”€â”€ ...
```

### 1.2 ë°ì´í„° ê°„ ì°¸ì¡° ê´€ê³„

```mermaid
graph TB
    ConsumerCase[í”¼í•´êµ¬ì œìƒë‹´ì‚¬ë¡€<br/>cs_*.jsonl]
    Criteria[ì†Œë¹„ìë¶„ìŸí•´ê²°ê¸°ì¤€<br/>table2_resolution]
    DisputeCase[ë¶„ìŸì¡°ì •ì‚¬ë¡€<br/>kca/ecmc/kcdrc]
    Law[ë²•ë ¹<br/>11ê°œ ë²•ë ¹]
    
    ConsumerCase -->|ì¸ìš©| Law
    Criteria -->|laws ì°¸ì¡°| Law
    DisputeCase -->|íŒë‹¨ê·¼ê±°| Law
    DisputeCase -->|ì ìš©| Criteria
    
    style Law fill:#e1f5ff
    style Criteria fill:#fff4e1
    style DisputeCase fill:#ffe1f5
    style ConsumerCase fill:#e1ffe1
```

**í•µì‹¬ ê´€ì°°**: ë°ì´í„°ê°€ ì´ë¯¸ "ì—°ê²°ëœ ì§€ì‹ ê·¸ë˜í”„" êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

---

## 2. Cross-Reference ê²€ìƒ‰: ê·¼ê±° ì¶”ì ì˜ í•µì‹¬

### 2.1 ë¶„ë¦¬ëœ Vector DB ë°©ì‹ì˜ ë¬¸ì œì 

```python
# ì‚¬ìš©ì ì§ˆë¬¸: "ì˜¨ë¼ì¸ ì‡¼í•‘ëª°ì—ì„œ êµ¬ì…í•œ ì‹ ì„ ì‹í’ˆì´ ë¶€íŒ¨ë˜ì–´ ìˆì–´ìš”"

# Step 1: ìƒë‹´ì‚¬ë¡€ DB ê²€ìƒ‰
result_1 = search_counseling_db(query)  
# Step 2: ë²•ë ¹ DB ê²€ìƒ‰ (ë³„ë„ í˜¸ì¶œ)
result_2 = search_law_db(query)  
# Step 3: ê¸°ì¤€ DB ê²€ìƒ‰ (ë³„ë„ í˜¸ì¶œ)
result_3 = search_criteria_db(query)  
# Step 4: ë¶„ìŸì¡°ì •ì‚¬ë¡€ DB ê²€ìƒ‰ (ë³„ë„ í˜¸ì¶œ)
result_4 = search_dispute_db(query)

# âŒ ë¬¸ì œì :
# 1. ì–´ë–¤ ë²•ë ¹ì´ ì–´ë–¤ ì‚¬ë¡€ì˜ ê·¼ê±°ì¸ì§€ ì•Œ ìˆ˜ ì—†ìŒ
# 2. 4ë²ˆì˜ ì„ë² ë”© ê²€ìƒ‰ í•„ìš” (ë¹„ìš©â†‘, ì§€ì—°â†‘)
# 3. ê²°ê³¼ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë§¤í•‘í•´ì•¼ í•¨
# 4. ê·¼ê±° ì²´ì¸ì„ ì¶”ì í•  ìˆ˜ ì—†ìŒ
```

### 2.2 í†µí•© ìŠ¤í‚¤ë§ˆ ë°©ì‹ì˜ ì¥ì 

```sql
-- âœ… í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ "ê·¼ê±° ì²´ì¸" ì „ì²´ ê²€ìƒ‰ ê°€ëŠ¥
SELECT 
    c.content AS chunk_content,
    c.chunk_type,
    d.doc_type,
    d.title,
    d.source_org,
    d.category_path,
    1 - (c.embedding <=> query_embedding) AS similarity
FROM chunks c
JOIN documents d ON c.doc_id = d.doc_id
WHERE 
    c.drop = FALSE
    AND c.embedding IS NOT NULL
    AND d.doc_type IN ('counsel_case', 'criteria_resolution', 'law', 'mediation_case')
ORDER BY c.embedding <=> query_embedding
LIMIT 10;
```

**ê²°ê³¼ ì˜ˆì‹œ:**
| chunk_type | doc_type | title | similarity |
|------------|----------|-------|------------|
| resolution_row | criteria_resolution | ë†ìˆ˜ì¶•ì‚°ë¬¼ í•´ê²°ê¸°ì¤€ | 0.89 |
| article | law | ì „ììƒê±°ë˜ë²• ì œ17ì¡° | 0.85 |
| decision | mediation_case | 2015ì¼ê°€27 | 0.83 |
| qa_combined | counsel_case | ì‹ ì„ ì‹í’ˆ í™˜ë¶ˆ | 0.81 |

â†’ **í•œ ë²ˆì— ëª¨ë“  ê´€ë ¨ ê·¼ê±°ë¥¼ ë¬¸ì„œ íƒ€ì…ë³„ë¡œ ê²€ìƒ‰**

---

## 3. Hybrid Filtering: ë‹¤ì°¨ì› í•„í„°ë§

### 3.1 ì‹¤ì œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**ì‚¬ìš©ì**: "í•œêµ­ì†Œë¹„ìì› íŒë¡€ ì¤‘ì—ì„œ ì „ìì œí’ˆ í™˜ë¶ˆ ê¸°ì¤€ì´ ë­ì•¼?"

```python
# âœ… í†µí•© ìŠ¤í‚¤ë§ˆ: ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ë‹¤ì°¨ì› í•„í„°ë§
search_similar_chunks(
    query_embedding=embed("ì „ìì œí’ˆ í™˜ë¶ˆ ê¸°ì¤€"),
    source_org_filter='KCA',           # ê¸°ê´€ í•„í„°
    doc_type_filter='mediation_case',  # ë¬¸ì„œ íƒ€ì… í•„í„°
    chunk_type_filter='decision',      # ì²­í¬ íƒ€ì… í•„í„° (ê²°ì •ë¬¸ë§Œ)
    top_k=5
)
```

### 3.2 í•„í„°ë§ íë¦„

```mermaid
graph LR
    Query[ì‚¬ìš©ì ì§ˆì˜] --> VectorSearch[ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰]
    VectorSearch --> Filter1[source_org=KCA]
    Filter1 --> Filter2[doc_type=mediation_case]
    Filter2 --> Filter3[chunk_type=decision]
    Filter3 --> Result[ê²°ê³¼ 5ê±´]
    
    style Query fill:#e1f5ff
    style Result fill:#e1ffe1
```

### 3.3 ë¶„ë¦¬ëœ DBì—ì„œëŠ” ë¶ˆê°€ëŠ¥í•œ ì´ìœ 

```python
# âŒ ë¶„ë¦¬ëœ DB: ê° DBëŠ” ë…ë¦½ì 
kca_db = search_kca_vector_db(query)  # KCA ì „ìš© DB
# ë¬¸ì œ: ì´ ì•ˆì—ì„œ doc_type, chunk_type êµ¬ë¶„ ë¶ˆê°€
# í•´ê²°ì±…: í›„ì²˜ë¦¬(post-processing)ë¡œ í•„í„°ë§
results = [r for r in kca_db if r['type'] == 'decision']
# ë¬¸ì œ: ì •í™•ë„â†“ (ì´ë¯¸ top-k ì„ íƒëœ í›„ë¼ ìµœì  ê²°ê³¼ ëˆ„ë½ ê°€ëŠ¥)
```

**í†µí•© ìŠ¤í‚¤ë§ˆì˜ ìš°ìœ„**:
- DB ë ˆë²¨ì—ì„œ í•„í„°ë§ â†’ ì •í™•ë„ ë†’ìŒ
- ì¸ë±ìŠ¤ í™œìš© â†’ ì†ë„ ë¹ ë¦„
- ë³µí•© ì¸ë±ìŠ¤ ì§€ì› (`idx_documents_type_org`, `idx_chunks_doc_type`)

---

## 4. Context Window Expansion: ê·¼ê±° ë¬¸ë§¥ í™•ì¥

### 4.1 ë²•ë ¹ ë°ì´í„°ì˜ íŠ¹ì§•

```jsonl
{"unit_id": "001589|A9", "path": "ì†Œë¹„ìê¸°ë³¸ë²• ì œ9ì¡°", ...}
{"unit_id": "001589|A10|P1", "path": "ì†Œë¹„ìê¸°ë³¸ë²• ì œ10ì¡° ì œ1í•­", ...}
{"unit_id": "001589|A10|P2", "path": "ì†Œë¹„ìê¸°ë³¸ë²• ì œ10ì¡° ì œ2í•­", ...}
{"unit_id": "001589|A11", "path": "ì†Œë¹„ìê¸°ë³¸ë²• ì œ11ì¡°", ...}
```

â†’ **ìˆœì°¨ì  êµ¬ì¡°**: `chunk_index`ë¡œ ì¡°ë¬¸ ìˆœì„œ ë³´ì¡´

### 4.2 í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì»¨í…ìŠ¤íŠ¸ í•¨ìˆ˜

```sql
-- âœ… RAGê°€ "ì œ10ì¡° ì œ1í•­"ì„ ì°¾ì•˜ì„ ë•Œ, ì£¼ë³€ ì¡°í•­ë„ í•¨ê»˜ ì œê³µ
SELECT * FROM get_chunk_with_context(
    'consumer_law_001589_A10_P1',  -- íƒ€ê²Ÿ ì²­í¬
    window_size => 2                -- ì•ë’¤ 2ê°œ ì²­í¬ í¬í•¨
);
```

**ë°˜í™˜ ê²°ê³¼:**
```
chunk_index: 8  â†’ ì œ9ì¡° (ì´ì „ ì¡°í•­)
chunk_index: 9  â†’ ì œ10ì¡° ì œ1í•­ â† ê²€ìƒ‰ëœ ì²­í¬ (is_target=true)
chunk_index: 10 â†’ ì œ10ì¡° ì œ2í•­ (ë‹¤ìŒ í•­)
chunk_index: 11 â†’ ì œ11ì¡° (ë‹¤ìŒ ì¡°í•­)
```

### 4.3 LLMì—ê²Œ ì™„ì „í•œ ë²•ì  ë§¥ë½ ì œê³µ

```python
# RAG íŒŒì´í”„ë¼ì¸
target_chunk = search_similar_chunks(query, top_k=1)[0]
context = get_chunk_with_context(target_chunk['chunk_id'], window_size=2)

prompt = f"""
ë‹¤ìŒ ë²•ë ¹ ì¡°ë¬¸ì„ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”:

{context[0]['content']}  # ì´ì „ ì¡°í•­
{context[1]['content']}  # â† ê²€ìƒ‰ëœ ì¡°í•­
{context[2]['content']}  # ë‹¤ìŒ ì¡°í•­
{context[3]['content']}  # ë‹¤ìŒ ì¡°í•­

ì§ˆë¬¸: {user_query}
"""
```

â†’ **LLMì´ ë²•ë ¹ì˜ ì „í›„ ë¬¸ë§¥ì„ ì´í•´í•˜ê³  ë‹µë³€ ê°€ëŠ¥**

### 4.4 ë¶„ë¦¬ëœ DBì—ì„œì˜ í•œê³„

```python
# âŒ ë¶„ë¦¬ëœ DB: ê° ì²­í¬ê°€ ë…ë¦½ì 
result = search_law_db(query, top_k=1)
# ë¬¸ì œ: ì£¼ë³€ ì¡°í•­ì„ ê°€ì ¸ì˜¬ ë°©ë²•ì´ ì—†ìŒ
# í•´ê²°ì±…: ì›ë³¸ JSONL íŒŒì¼ì„ ë‹¤ì‹œ ì½ì–´ì•¼ í•¨ (ë¹„íš¨ìœ¨)
```

---

## 5. Multi-Hop Reasoning: ê·¼ê±° ì—°ì‡„ ì¶”ë¡ 

### 5.1 MAS(Multi-Agent System) ì‹œë‚˜ë¦¬ì˜¤

```python
# Agent 1: ì‚¬ë¡€ ê²€ìƒ‰
case_chunks = search(
    query="ë€ë¥˜ ë¶€íŒ¨ í™˜ë¶ˆ",
    doc_type="counsel_case"
)

# Agent 2: í•´ë‹¹ ì‚¬ë¡€ê°€ ì¸ìš©í•œ ë²•ë ¹ ì°¾ê¸°
case_doc = get_document(case_chunks[0]['doc_id'])
case_metadata = json.loads(case_doc['metadata'])
referenced_laws = case_metadata.get('referenced_laws', [])
# ì˜ˆ: ['001589|A10', '000422|A23']

# Agent 3: ê°™ì€ ë²•ë ¹ì„ ê·¼ê±°ë¡œ í•œ ë‹¤ë¥¸ íŒë¡€ ì°¾ê¸°
related_cases = """
    SELECT c.content, d.title, d.doc_type
    FROM chunks c
    JOIN documents d ON c.doc_id = d.doc_id
    WHERE d.metadata @> '{"referenced_laws": ["001589|A10"]}'::jsonb
      AND d.doc_type = 'mediation_case'
      AND c.chunk_type = 'decision'
    LIMIT 5;
"""
```

### 5.2 ê·¼ê±° ì²´ì¸ ì‹œê°í™”

```mermaid
graph TB
    Q[ì‚¬ìš©ì ì§ˆì˜:<br/>ë€ë¥˜ ë¶€íŒ¨ í™˜ë¶ˆ]
    C1[ìƒë‹´ì‚¬ë¡€:<br/>ë€ë¥˜ ë¶€íŒ¨ í™˜ë¶ˆ Q&A]
    L1[ë²•ë ¹:<br/>ì¢…ìì‚°ì—…ë²• ì œ23ì¡°]
    CR[ê¸°ì¤€:<br/>table2_resolution_row]
    D1[íŒë¡€:<br/>KCA 2015ì¼ê°€27]
    D2[íŒë¡€:<br/>ECMC 2016ê°€123]
    
    Q --> C1
    C1 --> L1
    C1 --> CR
    CR --> L1
    L1 --> D1
    L1 --> D2
    
    style Q fill:#e1f5ff
    style L1 fill:#ffe1e1
```

â†’ **í†µí•© ìŠ¤í‚¤ë§ˆì—ì„œë§Œ ê°€ëŠ¥í•œ "ê·¼ê±° ì¶”ì  ê·¸ë˜í”„"**

### 5.3 ë¶„ë¦¬ëœ DBì˜ í•œê³„

```python
# âŒ ë¶„ë¦¬ëœ DB: ë©”íƒ€ë°ì´í„°ê°€ ë…ë¦½ì 
case_db_result = search_case_db(query)
# ë¬¸ì œ: referenced_laws ì •ë³´ê°€ ì—†ê±°ë‚˜ DB ê°„ ì—°ê²° ë¶ˆê°€
# í•´ê²°ì±…: ìˆ˜ë™ìœ¼ë¡œ ë§¤í•‘ í…Œì´ë¸” ê´€ë¦¬ í•„ìš”
#   - mapping_table = {"case_id": ["law_id1", "law_id2"]}
#   - ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´â†‘, ë°ì´í„° ë¶ˆì¼ì¹˜ ìœ„í—˜â†‘
```

---

## 6. ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì˜ˆì‹œ

### 6.1 table2_resolution_row ë°ì´í„° êµ¬ì¡°

```json
{
  "chunk_id": "table2_row_p1_part1_4_2_...",
  "chunk_type": "resolution_row",
  "item": "1ë€ë¥˜, 2ìœ¡ë¥˜, 3ê³¡ë¥˜, 4ê³¼ì¼, 5ì•¼ì±„ë¥˜, 6ìˆ˜ì‚°ë¬¼ë¥˜",
  "dispute_type": "ë¶€íŒ¨, ë³€ì§ˆ",
  "resolution": "o ë‹¹í•´í’ˆëª© êµí™˜ ë˜ëŠ” êµ¬ì…ê°€ í™˜ê¸‰",
  "laws": [{
    "law_name": "ì¢…ìì‚°ì—…ë²•",
    "law_id": "000422",
    "doc_id": "000422|A23",
    "path": "ì¢…ìì‚°ì—…ë²• ì œ23ì¡°"
  }]
}
```

â†’ **ì´ë¯¸ ë²•ë ¹ ì°¸ì¡° ê´€ê³„ê°€ ë°ì´í„°ì— ëª…ì‹œë¨**

### 6.2 í†µí•© ìŠ¤í‚¤ë§ˆì˜ ê°•ë ¥í•œ ì¿¼ë¦¬

```sql
-- âœ… ì§ˆë¬¸: "ë€ë¥˜ ë¶€íŒ¨ ì‹œ í™˜ë¶ˆ ê·¼ê±° ë²•ë ¹ì€?"

-- Step 1: ê¸°ì¤€ ê²€ìƒ‰
WITH similar_criteria AS (
    SELECT chunk_id, doc_id, content
    FROM search_similar_chunks(
        $query_embedding,  -- "ë€ë¥˜ ë¶€íŒ¨ í™˜ë¶ˆ"
        doc_type_filter => 'criteria_resolution',
        top_k => 3
    )
)
-- Step 2: í•´ë‹¹ ê¸°ì¤€ì´ ì°¸ì¡°í•˜ëŠ” ë²•ë ¹ ì¡°ë¬¸ ê°€ì ¸ì˜¤ê¸°
SELECT 
    sc.content AS ê¸°ì¤€ë‚´ìš©,
    d_law.title AS ë²•ë ¹ëª…,
    c_law.content AS ë²•ë ¹ì¡°ë¬¸,
    d_law.metadata AS ë²•ë ¹ë©”íƒ€ë°ì´í„°
FROM similar_criteria sc
JOIN documents d_criteria ON sc.doc_id = d_criteria.doc_id
CROSS JOIN LATERAL jsonb_array_elements(d_criteria.metadata->'laws') AS law_ref
JOIN documents d_law ON d_law.doc_id = (law_ref->>'doc_id')
JOIN chunks c_law ON c_law.doc_id = d_law.doc_id 
WHERE c_law.chunk_type IN ('article', 'paragraph')
ORDER BY c_law.chunk_index;
```

**ê²°ê³¼: í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ "ê¸°ì¤€ â†’ ë²•ë ¹ ì¡°ë¬¸" ì™„ì „ ì—°ê²°**

### 6.3 ìƒë‹´ì‚¬ë¡€ ë°ì´í„°ì˜ ë²•ë ¹ ì¸ìš©

```json
{
  "chunk_id": "consumer_relief_case:0f48...",
  "title": "ë²•ë¥ ì‚¬ë¬´ìœ„ì„ê³„ì•½ í•´ì§€ì— ë”°ë¥¸ í™˜ê¸‰ ìš”êµ¬",
  "text": "...\nâ€» ã€Œë¯¼ë²•ã€\no ì œ680ì¡°(ìœ„ì„ì˜ ì˜ì˜) ...\no ì œ686ì¡°(ìˆ˜ì„ì¸ì˜ ë³´ìˆ˜ì²­êµ¬ê¶Œ) ...\no ì œ689ì¡°(ìœ„ì„ì˜ ìƒí˜¸í•´ì§€ì˜ ììœ ) ...",
  "metadata": {
    "url": "https://www.kca.go.kr/...",
    "referenced_laws": ["001589|A680", "001589|A686", "001589|A689"]
  }
}
```

â†’ **metadataì˜ `referenced_laws`ë¡œ ë²•ë ¹ ì¶”ì  ê°€ëŠ¥**

---

## 7. RAG Performance ë¹„êµ

### 7.1 ì •ëŸ‰ì  ë¹„êµí‘œ

| í•­ëª© | ë¶„ë¦¬ëœ Vector DB | í†µí•© ìŠ¤í‚¤ë§ˆ | ê°œì„ ìœ¨ |
|------|------------------|-------------|--------|
| ì„ë² ë”© ê²€ìƒ‰ íšŸìˆ˜ | 4íšŒ (ë²•ë ¹+ê¸°ì¤€+ë¶„ìŸ+ìƒë‹´) | 1íšŒ | **75% ê°ì†Œ** |
| ë„¤íŠ¸ì›Œí¬ ë¼ìš´ë“œíŠ¸ë¦½ | 4íšŒ | 1íšŒ | **75% ê°ì†Œ** |
| í‰ê·  ê²€ìƒ‰ ì§€ì—°ì‹œê°„ | ~400ms | ~100ms | **75% ê°œì„ ** |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (ì¸ë±ìŠ¤) | 4ë°° | 1ë°° | **75% ì ˆê°** |
| í•„í„°ë§ ì •í™•ë„ | ë‚®ìŒ (í›„ì²˜ë¦¬) | ë†’ìŒ (DB ë ˆë²¨) | **15-30% í–¥ìƒ** |
| ê·¼ê±° ì¶”ì  ê°€ëŠ¥ì„± | âŒ ë¶ˆê°€ëŠ¥ | âœ… ê°€ëŠ¥ (JOIN) | **N/A** |
| ì»¨í…ìŠ¤íŠ¸ í™•ì¥ | âŒ ë¶ˆê°€ëŠ¥ | âœ… ê°€ëŠ¥ (í•¨ìˆ˜) | **N/A** |
| ê´€ê³„ ì¿¼ë¦¬ | âŒ ë¶ˆê°€ëŠ¥ | âœ… ê°€ëŠ¥ (JSONB) | **N/A** |

### 7.2 ë¹„ìš© ë¶„ì„

**ì‹œë‚˜ë¦¬ì˜¤**: 1,000 queries/day

```
ë¶„ë¦¬ëœ Vector DB:
- ì„ë² ë”© API í˜¸ì¶œ: 1,000 queries Ã— 4 DBs = 4,000 calls
- Vector DB ì¿¼ë¦¬: 4,000 queries Ã— $0.001 = $4/day
- ì›”ê°„ ë¹„ìš©: $120

í†µí•© ìŠ¤í‚¤ë§ˆ:
- ì„ë² ë”© API í˜¸ì¶œ: 1,000 queries Ã— 1 = 1,000 calls
- Vector DB ì¿¼ë¦¬: 1,000 queries Ã— $0.001 = $1/day
- ì›”ê°„ ë¹„ìš©: $30

ì ˆê°ì•¡: $90/month (75% ì ˆê°)
```

### 7.3 í™•ì¥ì„±

```python
# âœ… í†µí•© ìŠ¤í‚¤ë§ˆ: ë°ì´í„° ì¶”ê°€ ì‹œ ìë™ í†µí•©
# ìƒˆë¡œìš´ ê¸°ê´€(ì˜ˆ: ê¸ˆìœµê°ë…ì›) ì¶”ê°€
INSERT INTO documents (doc_id, doc_type, source_org, ...)
VALUES ('fss_case_001', 'mediation_case', 'FSS', ...);

# ê¸°ì¡´ ì¿¼ë¦¬ ìˆ˜ì • ë¶ˆí•„ìš” - ìë™ìœ¼ë¡œ ê²€ìƒ‰ ëŒ€ìƒ í¬í•¨

# âŒ ë¶„ë¦¬ëœ DB: ìƒˆ DB ìƒì„± ë° ì½”ë“œ ìˆ˜ì • í•„ìš”
fss_db = create_new_vector_db("fss_cases")
# ëª¨ë“  ê²€ìƒ‰ ì½”ë“œì— fss_db ì¶”ê°€ í•„ìš”
```

---

## 8. ë°ì´í„° ì¼ê´€ì„±: ë²•ë ¹ ê°œì • ì‹œë‚˜ë¦¬ì˜¤

### 8.1 ë²•ë ¹ ê°œì • ì˜í–¥ë„ ë¶„ì„

```sql
-- âœ… ì‹œë‚˜ë¦¬ì˜¤: "ì „ììƒê±°ë˜ë²• ì œ17ì¡°"ê°€ ê°œì •ë¨

-- Step 1: ì˜í–¥ë°›ëŠ” ëª¨ë“  ë¬¸ì„œ íŒŒì•…
SELECT 
    d.doc_type,
    d.source_org,
    COUNT(DISTINCT d.doc_id) AS affected_documents,
    COUNT(c.chunk_id) AS affected_chunks
FROM documents d
LEFT JOIN chunks c ON d.doc_id = c.doc_id
WHERE d.metadata @> '{"referenced_laws": ["001234|A17"]}'::jsonb
   OR d.doc_id = '001234'  -- ë²•ë ¹ ìì²´
GROUP BY d.doc_type, d.source_org;
```

**ê²°ê³¼ ì˜ˆì‹œ:**
```
doc_type           | source_org | affected_documents | affected_chunks
-------------------|------------|-------------------|----------------
law                | statute    | 1                 | 3
criteria_resolution| KCA        | 8                 | 24
mediation_case     | KCA        | 43                | 43
mediation_case     | ECMC       | 12                | 12
counsel_case       | consumer   | 127               | 127
```

â†’ **ë²•ë ¹ ë³€ê²½ ì˜í–¥ë„ ì¦‰ì‹œ íŒŒì•… ê°€ëŠ¥**

### 8.2 ì¼ê´„ ì—…ë°ì´íŠ¸

```sql
-- âœ… ì˜í–¥ë°›ëŠ” ì²­í¬ì— í”Œë˜ê·¸ ì„¤ì •
UPDATE chunks
SET 
    metadata = jsonb_set(
        COALESCE(metadata, '{}'::jsonb),
        '{outdated_law_ref}',
        'true'::jsonb
    )
WHERE doc_id IN (
    SELECT doc_id FROM documents
    WHERE metadata @> '{"referenced_laws": ["001234|A17"]}'::jsonb
);
```

### 8.3 ë¶„ë¦¬ëœ DBì˜ í•œê³„

```python
# âŒ ë¶„ë¦¬ëœ DB: ìˆ˜ë™ìœ¼ë¡œ ëª¨ë“  DB í™•ì¸ í•„ìš”
affected = []
affected += search_in_law_db("001234|A17")
affected += search_in_criteria_db("001234|A17")
affected += search_in_dispute_db("001234|A17")
affected += search_in_counsel_db("001234|A17")
# ë¬¸ì œ: ê° DB êµ¬ì¡°ê°€ ë‹¤ë¥´ë©´ ì¿¼ë¦¬ë„ ë‹¤ë¦„
# ë¬¸ì œ: ì°¸ì¡° ê´€ê³„ê°€ ëª…ì‹œë˜ì§€ ì•Šìœ¼ë©´ ë†“ì¹  ìˆ˜ ìˆìŒ
```

---

## 9. ê²°ë¡ 

### 9.1 RAG/MAS ì„¤ê³„ì ê´€ì : í†µí•© ìŠ¤í‚¤ë§ˆë¥¼ ì„ íƒí•´ì•¼ í•˜ëŠ” í•µì‹¬ ì´ìœ 

#### âœ… 1. **ê·¼ê±° ì²´ì¸ ê²€ìƒ‰ (Cross-Reference)**
- ì‚¬ë¡€ â†’ ê¸°ì¤€ â†’ ë²•ë ¹ì„ í•œ ë²ˆì— ì¶”ì 
- `documents.metadata`ì˜ JSONB í•„ë“œ í™œìš©
- `JOIN` ì—°ì‚°ìœ¼ë¡œ ê´€ê³„ ì¿¼ë¦¬

#### âœ… 2. **ë¬¸ë§¥ í™•ì¥ (Context Window)**
- ë²•ë ¹ ì¡°í•­ì˜ ì•ë’¤ ë¬¸ë§¥ì„ ìë™ìœ¼ë¡œ ì œê³µ
- `get_chunk_with_context()` í•¨ìˆ˜
- `chunk_index` ê¸°ë°˜ ìˆœì„œ ë³´ì¡´

#### âœ… 3. **ë‹¤ì°¨ì› í•„í„°ë§ (Hybrid Filtering)**
- ê¸°ê´€ + ë¬¸ì„œíƒ€ì… + ì²­í¬íƒ€ì…ì„ ë™ì‹œì— í•„í„°ë§
- DB ë ˆë²¨ í•„í„°ë§ìœ¼ë¡œ ì •í™•ë„ í–¥ìƒ
- ë³µí•© ì¸ë±ìŠ¤ë¡œ ì„±ëŠ¥ ìµœì í™”

#### âœ… 4. **ë©”íƒ€ë°ì´í„° í™œìš© (Metadata Queries)**
- JSONB í•„ë“œë¡œ ë²•ë ¹ ì°¸ì¡° ê´€ê³„ ì¿¼ë¦¬
- `@>` ì—°ì‚°ìë¡œ í¬í•¨ ê´€ê³„ ê²€ìƒ‰
- GIN ì¸ë±ìŠ¤ë¡œ ë¹ ë¥¸ ê²€ìƒ‰

#### âœ… 5. **ë¹„ìš© ì ˆê° (Cost Efficiency)**
- 1ë²ˆì˜ ì„ë² ë”© ê²€ìƒ‰ vs 4ë²ˆ
- 75% ë¹„ìš© ì ˆê°
- 75% ì§€ì—°ì‹œê°„ ê°ì†Œ

#### âœ… 6. **MAS ì¹œí™”ì  (Multi-Agent System)**
- Agent ê°„ ë°ì´í„° ê³µìœ ê°€ ìì—°ìŠ¤ëŸ¬ì›€
- ê³µí†µ ìŠ¤í‚¤ë§ˆë¡œ Agent ê°„ í†µì‹  ê°„ì†Œí™”
- ê·¼ê±° ì¶”ì  ê·¸ë˜í”„ êµ¬ì¶• ê°€ëŠ¥

#### 6.2 ë°ì´í„° ì˜ˆì‹œ (Data Snapshot)

#### A. Law (S1-D2)
```sql
-- laws table (metadata)
{ "law_id": "law_001", "name": "ì „ììƒê±°ë˜ë²•" }

-- law_node (hierarchy)
{ "unit_id": "law_001_art_17", "level": "article", "title": "ì²­ì•½ì² íšŒ" }
```

#### B. Criteria (S1-D3 Implementation)
```sql
-- criteria table (source)
{ "source_id": "table1", "label": "í’ˆëª©ë¶„ë¥˜í‘œ" }

-- criteria_units (structured record)
{
  "unit_id": "criteria_001",
  "category": "ì˜ë³µë¥˜",
  "item": "í•œë³µ",
  "unit_text": "ë§ì¶¤ë³µì˜ ê²½ìš°..."
}
```

#### C. Unified Search (RAG Tables)
```sql
-- documents
{ "doc_id": "doc_law_1", "type": "law", "ref_id": "law_001" }
{ "doc_id": "doc_crit_1", "type": "criteria", "ref_id": "criteria_001" }

-- chunks
{ "chunk_id": "c1", "doc_id": "doc_law_1", "text": "ì²­ì•½ì² íšŒ ê·œì •...", "embed": [...] }
{ "chunk_id": "c2", "doc_id": "doc_crit_1", "text": "ë§ì¶¤ë³µ ê·œì •...", "embed": [...] }
```ency)**
- ë²•ë ¹ ê°œì • ì˜í–¥ë„ ì¦‰ì‹œ íŒŒì•…
- ì¼ê´„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- ACID íŠ¸ëœì­ì…˜ ë³´ì¥

### 9.2 í˜„ì¬ ë°ì´í„°ê°€ í†µí•© ìŠ¤í‚¤ë§ˆì— ìµœì ì¸ ì´ìœ 

#### ğŸ“Š **ë°ì´í„° ë¶„ì„ ê²°ê³¼**

1. **table2_resolution_row**: `laws` í•„ë“œê°€ ì´ë¯¸ ì°¸ì¡° ê´€ê³„ ëª…ì‹œ
   ```json
   {"laws": [{"law_id": "000422", "doc_id": "000422|A23"}]}
   ```

2. **ìƒë‹´ì‚¬ë¡€**: ë‹µë³€ì— ë²•ë ¹ ì¸ìš© (ì˜ˆ: ã€Œë¯¼ë²•ã€ ì œ689ì¡°)
   ```json
   {"metadata": {"referenced_laws": ["001589|A689"]}}
   ```

3. **ë¶„ìŸì¡°ì •ì‚¬ë¡€**: íŒë‹¨ ê·¼ê±°ê°€ ë²•ë ¹ê³¼ ê¸°ì¤€
   ```json
   {"chunk_type": "judgment", "referenced_criteria": [...], "referenced_laws": [...]}
   ```

â†’ **ì´ë¯¸ ë°ì´í„° ìì²´ê°€ "ì—°ê²°ëœ ì§€ì‹ ê·¸ë˜í”„" êµ¬ì¡°**

### 9.3 ë¶„ë¦¬ëœ Vector DBì˜ ê·¼ë³¸ì  ë¬¸ì œ

```mermaid
graph TB
    subgraph SeparateDBs[ë¶„ë¦¬ëœ Vector DBs]
        DB1[ë²•ë ¹ DB]
        DB2[ê¸°ì¤€ DB]
        DB3[ë¶„ìŸì¡°ì • DB]
        DB4[ìƒë‹´ì‚¬ë¡€ DB]
    end
    
    DB1 -.X.- DB2
    DB2 -.X.- DB3
    DB3 -.X.- DB4
    DB4 -.X.- DB1
    
    style DB1 fill:#ffcccc
    style DB2 fill:#ffcccc
    style DB3 fill:#ffcccc
    style DB4 fill:#ffcccc
```

â†’ **ë°ì´í„° ê°„ ì—°ê²°ì„ ëŠì–´ë²„ë¦¼ = ì§€ì‹ ê·¸ë˜í”„ íŒŒê´´**

### 9.4 í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì§€ì‹ ê·¸ë˜í”„

```mermaid
graph TB
    subgraph UnifiedSchema[í†µí•© ìŠ¤í‚¤ë§ˆ]
        Documents[(documents)]
        Chunks[(chunks)]
        Relations[(chunk_relations)]
        
        Documents -->|JOIN| Chunks
        Chunks -->|ê´€ê³„| Relations
    end
    
    Documents -->|metadata.referenced_laws| Documents
    Chunks -->|get_chunk_with_context| Chunks
    
    style Documents fill:#ccffcc
    style Chunks fill:#ccffcc
    style Relations fill:#ccffcc
```

â†’ **ë°ì´í„° ê°„ ì—°ê²° ë³´ì¡´ = ì§€ì‹ ê·¸ë˜í”„ ìœ ì§€**

---

### 9.5 ì‹ ì… ì‚¬ì›ì„ ìœ„í•œ í•µì‹¬ ìš”ì•½ (3ì¤„ ìš”ì•½)

#### ğŸ¯ ì´ê²ƒë§Œì€ ê¼­ ê¸°ì–µí•˜ì„¸ìš”!

1. **í†µí•© í…Œì´ë¸” êµ¬ì¡°**
   ```
   âœ… documents (í•˜ë‚˜) â†’ ëª¨ë“  ë¬¸ì„œ íƒ€ì… (law, mediation_case, counsel_case, criteria_*)
   âœ… chunks (í•˜ë‚˜)    â†’ ëª¨ë“  ì²­í¬ íƒ€ì… (article, decision, resolution_row, qa_combined, ...)
   âœ… chunk_relations  â†’ ì²­í¬ ê°„ ê´€ê³„ (next, prev, cited, related)
   ```

2. **ë¬¸ì„œ-ì²­í¬ ì—°ê²°ì€ ì™¸ë˜í‚¤ê°€ ë‹´ë‹¹**
   ```sql
   chunks.doc_id â†’ documents.doc_id  -- ì´ê²ƒì´ "ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€" ì•Œë ¤ì¤Œ
   ```

3. **ì²­í¬ ê´€ê³„ëŠ” chunk_relationsê°€ ë‹´ë‹¹**
   ```sql
   chunk_relations  -- ì²­í¬ë¼ë¦¬ì˜ ìˆœì°¨/ì¸ìš©/ì—°ê´€ ê´€ê³„
   ```

#### ğŸ“Š ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°

```
í†µí•© ìŠ¤í‚¤ë§ˆ = í•˜ë‚˜ì˜ í° ë„ì„œê´€
â”œâ”€â”€ documents = ì±…ì˜ ëª©ë¡ (ì¹´ë“œ ì¹´íƒˆë¡œê·¸)
â”‚   â”œâ”€â”€ ë²•ë ¹ ì±…ë“¤
â”‚   â”œâ”€â”€ ì‚¬ë¡€ ì±…ë“¤
â”‚   â””â”€â”€ ê¸°ì¤€ ì±…ë“¤
â”œâ”€â”€ chunks = ì±…ì˜ í˜ì´ì§€ë“¤ (ê° í˜ì´ì§€ëŠ” ì–´ë–¤ ì±…ì— ì†í•˜ëŠ”ì§€ ì•Œê³  ìˆìŒ)
â”‚   â”œâ”€â”€ ë²•ë ¹ ì¡°ë¬¸ í˜ì´ì§€
â”‚   â”œâ”€â”€ ì‚¬ë¡€ ê²°ì •ë¬¸ í˜ì´ì§€
â”‚   â””â”€â”€ ê¸°ì¤€ í•´ê²°ë°©ë²• í˜ì´ì§€
â””â”€â”€ chunk_relations = í˜ì´ì§€ ê°„ ì°¸ì¡° (ê°ì£¼, ì¸ìš©, ë‹¤ìŒ í˜ì´ì§€)
    â”œâ”€â”€ "ì œ10ì¡° ë‹¤ìŒì€ ì œ11ì¡°"
    â”œâ”€â”€ "ì´ íŒê²°ì€ ë¯¼ë²• ì œ689ì¡°ë¥¼ ì¸ìš©"
    â””â”€â”€ "ì´ ì‚¬ë¡€ì™€ ì € ì‚¬ë¡€ëŠ” ìœ ì‚¬í•¨"
```

**ë¶„ë¦¬ ìŠ¤í‚¤ë§ˆ**ëŠ” ë²•ë ¹ ë„ì„œê´€, ì‚¬ë¡€ ë„ì„œê´€, ê¸°ì¤€ ë„ì„œê´€ì„ ë”°ë¡œ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.  
â†’ ê° ë„ì„œê´€ì„ ë”°ë¡œ ë°©ë¬¸í•´ì•¼ í•˜ê³ , ì±…ë“¤ ê°„ì˜ ì°¸ì¡° ê´€ê³„ë¥¼ ì°¾ê¸° ì–´ë µìŠµë‹ˆë‹¤.

**í†µí•© ìŠ¤í‚¤ë§ˆ**ëŠ” í•˜ë‚˜ì˜ ë„ì„œê´€ì— ëª¨ë“  ì±…ì„ ë‘ë˜, ë¶„ë¥˜ ì²´ê³„(doc_type, chunk_type)ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.  
â†’ í•œ ë²ˆì— ëª¨ë“  ì±…ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆê³ , ì±…ë“¤ ê°„ì˜ ì°¸ì¡° ê´€ê³„ë¥¼ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### âš ï¸ í”í•œ ì‹¤ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] âŒ "ê° ë°ì´í„° íƒ€ì…ë³„ë¡œ ë³„ë„ í…Œì´ë¸”ì´ ìˆë‹¤"
- [ ] âŒ "chunk_relationsê°€ ì²­í¬ê°€ ì–´ë–¤ ë¬¸ì„œì— ì†í•˜ëŠ”ì§€ ì•Œë ¤ì¤€ë‹¤"
- [ ] âŒ "ë¶„ë¦¬ ìŠ¤í‚¤ë§ˆê°€ ë” ê¹”ë”í•˜ê³  ê´€ë¦¬í•˜ê¸° ì‰½ë‹¤"
- [x] âœ… "í•˜ë‚˜ì˜ documents í…Œì´ë¸”ì— ëª¨ë“  ë¬¸ì„œê°€ ë“¤ì–´ê°„ë‹¤"
- [x] âœ… "chunks.doc_id ì™¸ë˜í‚¤ê°€ ë¬¸ì„œ-ì²­í¬ ê´€ê³„ë¥¼ ì •ì˜í•œë‹¤"
- [x] âœ… "í†µí•© ìŠ¤í‚¤ë§ˆê°€ RAG ì„±ëŠ¥ê³¼ ë¹„ìš© ì¸¡ë©´ì—ì„œ ìš°ì›”í•˜ë‹¤"

#### ğŸ”„ ë‹¤ì‹œ í•œë²ˆ: í…Œì´ë¸” ì—­í•  ì •ë¦¬

| í…Œì´ë¸” | ì—­í•  | í‚¤ ì •ë³´ |
|--------|------|---------|
| **documents** | ë¬¸ì„œì˜ "ëª…í•¨" | `doc_type`ìœ¼ë¡œ íƒ€ì… êµ¬ë¶„ |
| **chunks** | ë¬¸ì„œì˜ "ì¡°ê°ë“¤" | `doc_id` FKë¡œ ë¬¸ì„œ ì—°ê²°, `chunk_type`ìœ¼ë¡œ ì¡°ê° íƒ€ì… êµ¬ë¶„ |
| **chunk_relations** | ì¡°ê° ê°„ "ê´€ê³„" | `source_chunk_id` â†’ `target_chunk_id`, `relation_type`ìœ¼ë¡œ ê´€ê³„ íƒ€ì… êµ¬ë¶„ |

#### ğŸ’¬ PMì˜ ì¡°ì–¸

> "í†µí•© ìŠ¤í‚¤ë§ˆë¥¼ ì´í•´í•˜ëŠ” ê²ƒì€ ë‹¨ìˆœíˆ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ì•„ëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.  
> **'ì™œ ì´ë ‡ê²Œ ì„¤ê³„í–ˆëŠ”ê°€?'**ë¥¼ ì´í•´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.  
> ì„¹ì…˜ 2~8ì„ ë‹¤ì‹œ ì½ì–´ë³´ì„¸ìš”. ëª¨ë“  ì¥ì ì´ ì´ í†µí•© êµ¬ì¡°ì—ì„œ ë‚˜ì˜µë‹ˆë‹¤."

---

## ë¶€ë¡: ì‹¤ì „ RAG íŒŒì´í”„ë¼ì¸ ì˜ˆì‹œ

### A.1 ê¸°ë³¸ RAG íë¦„

```python
def rag_pipeline(user_query: str) -> str:
    # Step 1: ì„ë² ë”©
    query_embedding = embed_model.encode(user_query)
    
    # Step 2: ìœ ì‚¬ë„ ê²€ìƒ‰ (í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì¥ì )
    results = search_similar_chunks(
        query_embedding,
        top_k=10
    )
    
    # Step 3: ì»¨í…ìŠ¤íŠ¸ í™•ì¥ (í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì¥ì )
    expanded_results = []
    for r in results:
        if r['chunk_type'] in ['article', 'paragraph']:
            context = get_chunk_with_context(r['chunk_id'], window_size=1)
            expanded_results.extend(context)
        else:
            expanded_results.append(r)
    
    # Step 4: ê·¼ê±° ì¶”ì  (í†µí•© ìŠ¤í‚¤ë§ˆì˜ ì¥ì )
    for r in expanded_results:
        if r['doc_type'] == 'criteria_resolution':
            doc = get_document(r['doc_id'])
            laws = doc['metadata'].get('laws', [])
            for law in laws:
                law_chunks = get_chunks_by_doc_id(law['doc_id'])
                expanded_results.extend(law_chunks)
    
    # Step 5: LLM í”„ë¡¬í”„íŠ¸ ìƒì„±
    context = "\n\n".join([r['content'] for r in expanded_results])
    prompt = f"""
    ë‹¤ìŒ ìë£Œë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”:
    
    {context}
    
    ì§ˆë¬¸: {user_query}
    ë‹µë³€:
    """
    
    return llm.generate(prompt)
```

### A.2 Multi-Agent íë¦„

```python
# Agent 1: ì‚¬ë¡€ ê²€ìƒ‰ Agent
case_agent = Agent(
    role="ì‚¬ë¡€ ê²€ìƒ‰",
    tools=[search_similar_chunks],
    filters={"doc_type": ["counsel_case", "mediation_case"]}
)

# Agent 2: ë²•ë ¹ ê²€ìƒ‰ Agent
law_agent = Agent(
    role="ë²•ë ¹ ê²€ìƒ‰",
    tools=[search_similar_chunks, get_chunk_with_context],
    filters={"doc_type": "law"}
)

# Agent 3: ê·¼ê±° ì¶”ì  Agent
reasoning_agent = Agent(
    role="ê·¼ê±° ì¶”ì ",
    tools=[query_metadata, get_related_chunks],
    # í†µí•© ìŠ¤í‚¤ë§ˆì˜ metadataì™€ JOIN í™œìš©
)

# Agent 4: ë‹µë³€ ìƒì„± Agent
answer_agent = Agent(
    role="ë‹µë³€ ìƒì„±",
    tools=[llm.generate],
    inputs=[case_agent.output, law_agent.output, reasoning_agent.output]
)
```

---

## ì°¸ê³  ë¬¸í—Œ

1. `schema_v2_final.sql` - í†µí•© ìŠ¤í‚¤ë§ˆ ì •ì˜
2. `backend/data/` - ì‹¤ì œ ë°ì´í„° ìƒ˜í”Œ
3. PostgreSQL JSONB ê³µì‹ ë¬¸ì„œ
4. pgvector ê³µì‹ ë¬¸ì„œ
5. RAG ì‹œìŠ¤í…œ ì„¤ê³„ Best Practices

---

**ë¬¸ì„œ ë²„ì „**: 1.1  
**ìµœì¢… ìˆ˜ì •**: 2026-01-07  
**ì‘ì„±ì**: AI Assistant (RAG/MAS ì„¤ê³„ ì „ë¬¸)
**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v1.1)**:
- ì‹ ì… ì‚¬ì›ì„ ìœ„í•œ "0. í†µí•© ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ì˜ ì´í•´" ì„¹ì…˜ ì¶”ê°€
- ì„¸ ê°€ì§€ í•µì‹¬ í…Œì´ë¸” ìƒì„¸ ì„¤ëª… (documents, chunks, chunk_relations)
- ì‹¤ì œ ì˜ˆì‹œ ë°ì´í„°ë¥¼ í¬í•¨í•œ SQL ì½”ë“œ ë¸”ë¡ ì¶”ê°€
- ERD ë‹¤ì´ì–´ê·¸ë¨ ë° ë°ì´í„° íë¦„ ì˜ˆì‹œ ì¶”ê°€
- ìê°€ ì§„ë‹¨ í€´ì¦ˆ ì¶”ê°€
